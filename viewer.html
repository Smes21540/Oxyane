<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Tra√ßabilit√© S√©choir</title>
<style>
:root{
  --bg:#fff5f5;
  --panel:#fff0e5;
  --sidebar-bg:#ffe5d9;
  --text:#333;
  --muted-text:#555;
  --shadow:rgba(0,0,0,0.1);
  --accent:#ff7043;
  --accent-darker:#e64a19;
  --accent-muted:#ffccbc;
  --danger:#d84315;
}

html,body{height:100%;margin:0;overflow:hidden;}
body { 
  font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; 
  background-color: var(--bg); 
  padding: 5px 20px 7px 20px; 
  color: var(--danger); 
  font-size: 14px; 
  display:flex;
  flex-direction:column;
}

.header { position: relative; display: flex; align-items: center; justify-content: center; margin: 0 0 10px 0; }
.header .logo { height: 60px; width: auto; }
#fileNameContainer { position: absolute; right: 0; top: 0; text-align: right; }
#fileName, #lineCount { color: var(--danger); }
#fileName { font-size: 24px; font-weight: bold; white-space: nowrap; max-width: 300px; overflow: hidden; text-overflow: ellipsis; display: none; }
#lineCount { font-size: 12px; display: none; }

.controls, #columnToggles { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin: 5px 0; }
button { background-color: var(--accent); color: white; border: none; cursor: pointer; font-weight: bold; padding: 8px 12px; border-radius: 6px; font-size: 13px; transition: background-color 0.3s ease, transform 0.2s ease; }
button:hover { background-color: var(--accent-darker); transform: scale(1.05); }
button:disabled { background-color: #ccc; color: #666; cursor: not-allowed; transform:none; }
#toggleColumnsBtn { padding: 6px 10px; border-radius: 6px; border: 1px solid var(--accent-darker); background-color: var(--accent); color: white; cursor: pointer; font-size: 13px; }
#toggleColumnsBtn:hover { background-color: var(--accent-darker); }

#tableWrapper { flex:1; overflow-y:auto; text-align:center; }
#tableContainer { display: inline-block; overflow: auto; min-width:100%; border-radius: 8px; box-shadow: 0 4px 12px var(--shadow); background: var(--panel); text-align: center; }

table { width: auto; border-collapse: separate; border-spacing: 0; table-layout: auto; font-size: 13px; }
thead th, tbody td { padding: 10px 12px; text-align: left; border-bottom: 1px solid var(--sidebar-bg); white-space: nowrap; transition: background-color 0.6s ease, color 0.6s ease; }
thead th { position: sticky; top: 0; z-index: 2; background-color: var(--accent); color: white; font-weight: bold; text-transform: uppercase; letter-spacing: 0.05em; cursor: pointer; user-select: none; font-size: 12px; }
thead th:hover { background-color: var(--accent-darker); }
tbody tr:nth-child(even) { background-color: var(--sidebar-bg); }
tbody tr:nth-child(odd) { background-color: var(--panel); }
tbody tr:hover { background-color: var(--accent-muted); transition: background-color 0.3s ease; }
thead th.sorted-asc::after { content: " ‚ñ≤"; font-size: 10px; }
thead th.sorted-desc::after { content: " ‚ñº"; font-size: 10px; }

#columnToggles label { font-size: 12px; cursor: pointer; margin-right:5px; }
#columnToggles input[type="checkbox"] { width: 14px; height: 14px; vertical-align: middle; margin-right:3px; }
#columnToggles { display: none; }

.flash-red { animation: flashRed 0.6s ease; }
@keyframes flashRed { 0% { background-color: var(--accent-muted); } 100% { background-color: var(--panel); } }

/* Menu secret */
#secretBtn{position:fixed;bottom:10px;right:10px;width:25px;height:25px;opacity:0;cursor:pointer;z-index:2000;}
#themeMenu{display:none;position:fixed;bottom:50px;right:10px;background: var(--panel);
  border:2px solid var(--accent);border-radius:8px;box-shadow:0 4px 12px var(--shadow);
  padding:10px;z-index:2001;min-width:150px;}
#themeMenu h3 {margin:0 0 8px 0;font-size:14px;color: var(--accent);}
#themeMenu .closeMenu {position:absolute;top:5px;right:8px;font-size:14px;cursor:pointer;color:var(--accent);}
#themeMenu .closeMenu:hover {color:var(--accent-darker);}
#themeMenu button {display:block;width:100%;margin:4px 0;padding:6px;border:none;border-radius:6px;background: var(--accent);color: white;cursor:pointer;font-size:13px;}
#themeMenu button:hover {background: var(--accent-darker);}

/* Overlay + Spinner */
#loadingOverlay{
  position:fixed; inset:0; background:rgba(0,0,0,0.05);
  display:none; z-index:2500;
}
#spinner{
  position:absolute; top:50%; left:50%;
  width:40px; height:40px; margin:-20px 0 0 -20px;
  border:6px solid #f3f3f3; border-top:6px solid var(--accent);
  border-radius:50%; animation:spin 0.8s linear infinite;
}
@keyframes spin { from { transform: rotate(0deg);} to { transform: rotate(360deg);} }
</style>
</head>
<body>

<div class="header">
  <img src="img/logo.png" alt="Logo SMES France" class="logo" id="mainLogo"/>
  <div id="fileNameContainer">
    <div id="fileName"></div>
    <div id="lineCount"></div>
  </div>
</div>

<div class="controls">
  <button id="backBtn">‚¨ÖÔ∏è Retour</button>
  <button id="prevFile">‚¨ÖÔ∏è Fichier pr√©c√©dent</button>
  <button id="nextFile">Fichier suivant ‚û°Ô∏è</button>
  <input type="text" id="searchInput" placeholder="üîé Rechercher..." />
  <button id="exportExcel">üìä Export Excel</button>
  <button id="exportPDF">üìÑ Export PDF</button>
  <button id="toggleColumnsBtn">Afficher/Masquer colonnes</button>
  <button id="resetBtn">‚ôªÔ∏è R√©initialiser affichage</button>
</div>

<div id="columnToggles"></div>
<div id="tableWrapper"><div id="tableContainer"></div></div>

<!-- Overlay + spinner -->
<div id="loadingOverlay" aria-hidden="true">
  <div id="spinner" role="status" aria-label="Chargement"></div>
</div>

<!-- Menu secret -->
<div id="secretBtn"></div>
<div id="themeMenu">
  <span class="closeMenu" onclick="closeThemeMenu()">‚ùå</span>
  <h3>Choisir un th√®me</h3>
  <button onclick="setTheme('orange')">Orange (d√©faut)</button>
  <button onclick="setTheme('blue')">Bleu</button>
  <button onclick="setTheme('green')">Vert</button>
  <button onclick="setTheme('purple')">Violet</button>
  <button onclick="setTheme('bordeaux')">Bordeaux</button>
</div>

<script src="libs/papaparse.min.js"></script>
<script src="libs/xlsx.full.min.js"></script>
<script src="libs/jspdf.umd.min.js"></script>
<script src="libs/jspdf.plugin.autotable.min.js"></script>
<script>
// === Variables ===
const API_KEY='AIzaSyCbEV3CS9bOcxq5eK-QXbjczGHjvzyXS6M';
let currentData=[], sortAsc=true, sortColIndex=null, visibleColumns={}, columnVisibilityMemory={}, columnSortMemory={colName:null,asc:true}, lastSearchQuery="";
let themeMenuTimer;
let csvFilesList = JSON.parse(localStorage.getItem("csvFilesList")||"[]");
let currentIndex = parseInt(localStorage.getItem("csvFileIndex")||"0",10);

// === Th√®mes ===
function setTheme(theme){
  const r=document.documentElement;
  const logo=document.getElementById("mainLogo");
  logo.style.display=(theme==="orange")?"block":"none";
  localStorage.setItem("selectedTheme",theme);

  if(theme==="orange"){r.style.setProperty("--accent","#ff7043");r.style.setProperty("--accent-darker","#e64a19");r.style.setProperty("--accent-muted","#ffccbc");r.style.setProperty("--bg","#fff5f5");r.style.setProperty("--panel","#ffffff");r.style.setProperty("--sidebar-bg","#ffe5d9");r.style.setProperty("--danger","#d84315");r.style.setProperty("--text","#333");}
  if(theme==="blue"){r.style.setProperty("--accent","#2196f3");r.style.setProperty("--accent-darker","#1976d2");r.style.setProperty("--accent-muted","#bbdefb");r.style.setProperty("--bg","#e3f2fd");r.style.setProperty("--panel","#ffffff");r.style.setProperty("--sidebar-bg","#bbdefb");r.style.setProperty("--danger","#0d47a1");r.style.setProperty("--text","#0d47a1");}
  if(theme==="green"){r.style.setProperty("--accent","#4caf50");r.style.setProperty("--accent-darker","#2e7d32");r.style.setProperty("--accent-muted","#c8e6c9");r.style.setProperty("--bg","#f1f8e9");r.style.setProperty("--panel","#ffffff");r.style.setProperty("--sidebar-bg","#c8e6c9");r.style.setProperty("--danger","#1b5e20");r.style.setProperty("--text","#1b5e20");}
  if(theme==="purple"){r.style.setProperty("--accent","#9c27b0");r.style.setProperty("--accent-darker","#6a1b9a");r.style.setProperty("--accent-muted","#e1bee7");r.style.setProperty("--bg","#f3e5f5");r.style.setProperty("--panel","#ffffff");r.style.setProperty("--sidebar-bg","#e1bee7");r.style.setProperty("--danger","#4a148c");r.style.setProperty("--text","#4a148c");}
  if(theme==="bordeaux"){r.style.setProperty("--accent","#800020");r.style.setProperty("--accent-darker","#4b0014");r.style.setProperty("--accent-muted","#d7a1a9");r.style.setProperty("--bg","#fff0f2");r.style.setProperty("--panel","#ffffff");r.style.setProperty("--sidebar-bg","#f3cdd3");r.style.setProperty("--danger","#600018");r.style.setProperty("--text","#4b0014");}
}
document.getElementById("secretBtn").onclick=()=>{const menu=document.getElementById("themeMenu");if(menu.style.display==="block"){closeThemeMenu();}else{menu.style.display="block";resetThemeMenuTimer();}};
function resetThemeMenuTimer(){clearTimeout(themeMenuTimer);themeMenuTimer=setTimeout(closeThemeMenu,10000);}
function closeThemeMenu(){document.getElementById("themeMenu").style.display="none";clearTimeout(themeMenuTimer);}

// === Navigation fichiers ===
function updateNavButtons(){
  document.getElementById("prevFile").disabled = (currentIndex >= csvFilesList.length-1);
  document.getElementById("nextFile").disabled = (currentIndex <= 0);
}
document.getElementById("prevFile").onclick=()=>{ if(currentIndex < csvFilesList.length-1){ const f=csvFilesList[currentIndex+1]; if(f){localStorage.setItem("csvFileIndex",currentIndex+1);window.location.href=`viewer.html?fileId=${f.id}&fileName=${encodeURIComponent(f.name)}`;}}};
document.getElementById("nextFile").onclick=()=>{ if(currentIndex > 0){ const f=csvFilesList[currentIndex-1]; if(f){localStorage.setItem("csvFileIndex",currentIndex-1);window.location.href=`viewer.html?fileId=${f.id}&fileName=${encodeURIComponent(f.name)}`;}}};
document.getElementById("backBtn").onclick=()=>window.close();

// === Spinner ===
function showLoading(){ document.getElementById('loadingOverlay').style.display='block'; }
function hideLoading(){ document.getElementById('loadingOverlay').style.display='none'; }

// === Charger CSV ===
async function loadCSV(){
  const fileId=new URLSearchParams(window.location.search).get('fileId');
  const fileName=new URLSearchParams(window.location.search).get('fileName');
  const fileNameDiv=document.getElementById('fileName');
  const lineCountDiv=document.getElementById('lineCount');
  const container=document.getElementById('tableContainer');
  if(!fileId) return;

  fileNameDiv.textContent=fileName||''; 
  fileNameDiv.style.display='block'; 
  lineCountDiv.style.display='block';

  const url=`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media&key=${API_KEY}`;
  showLoading();
  try {
    const response=await fetch(url);
    if(!response.ok) throw new Error("HTTP " + response.status);

    const blob=await response.blob();
    const arrayBuffer=await blob.arrayBuffer();
    let text;
    try{ text=new TextDecoder('windows-1252').decode(arrayBuffer); }
    catch{ text=new TextDecoder('utf-8').decode(arrayBuffer); }

    const results=Papa.parse(text,{header:false,skipEmptyLines:true});
    currentData=results.data;
    const rowCount=currentData.length>1?currentData.length-1:0;
    lineCountDiv.textContent=rowCount+" ligne"+(rowCount!==1?"s":"");
    renderTable(currentData);
  } catch(err){
    console.error("Erreur:",err);
    container.innerHTML=`
      <div style="padding:20px; background:#ffccbc; color:#d84315; border-radius:8px; font-weight:bold;">
        ‚ö†Ô∏è Impossible de charger le fichier CSV.<br>
        Cause probable : restriction Google Drive (CORS) ou probl√®me r√©seau.<br>
        <button id="retryBtn" style="margin-top:10px; background:#e64a19; color:#fff; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; font-weight:bold;">
          üîÑ R√©essayer
        </button>
      </div>`;
    document.getElementById("retryBtn").onclick=()=>{container.innerHTML="‚è≥ Nouvelle tentative...";loadCSV();};
  } finally {
    hideLoading();
    updateNavButtons();
  }
}

// === Rendu tableau ===
function escapeHtml(str){ return str.replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[m])); }
function renderTable(data){
  let html='<table id="csvTable">';
  if(data.length>0){
    html+='<thead><tr>';
    data[0].forEach((cell,index)=>{
      let cls=(index===sortColIndex)?(sortAsc?"sorted-desc":"sorted-asc"):"";
      html+=`<th class="${cls}" onclick="sortTable(${index})">${escapeHtml((cell??'').toString().trim())}</th>`;
    });
    html+='</tr></thead>';
  }
  html+='<tbody>';
  for(let i=1;i<data.length;i++){
    html+='<tr>';
    data[i].forEach((cell,index)=> html+=`<td>${escapeHtml((cell??'').toString().trim())}</td>`);
    html+='</tr>';
  }
  html+='</tbody></table>';
  document.getElementById('tableContainer').innerHTML=html;

  const toggleContainer=document.getElementById('columnToggles');
  toggleContainer.innerHTML=`<label style="font-weight:bold;"><input type="checkbox" id="selectAll" /> Tout</label>
                             <label style="font-weight:bold;"><input type="checkbox" id="selectNone" /> Aucune</label>`;
  if(data.length>0){
    data[0].forEach((cell,index)=>{
      const colName=(cell??'').toString().trim(), id=`colToggle${index}`, checked=columnVisibilityMemory[colName]!==false;
      visibleColumns[index]=checked;
      toggleContainer.innerHTML+=`<label><input type="checkbox" id="${id}" data-col="${index}" ${checked?"checked":""} /> ${escapeHtml(colName)}</label>`;
    });
    toggleContainer.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
      const colIndex=cb.dataset.col;
      if(colIndex!==undefined) cb.addEventListener('change',()=>toggleColumn(colIndex, cb.checked));
    });
    document.getElementById('selectAll').addEventListener('change',e=>{
      const checked=e.target.checked;
      document.querySelectorAll('#columnToggles input[type="checkbox"]').forEach(cb=>{ if(cb.dataset.col!==undefined){ cb.checked=checked; toggleColumn(cb.dataset.col, checked); }});
      document.getElementById('selectNone').checked=false;
    });
    document.getElementById('selectNone').addEventListener('change',e=>{
      const checked=e.target.checked;
      document.querySelectorAll('#columnToggles input[type="checkbox"]').forEach(cb=>{ if(cb.dataset.col!==undefined){ cb.checked=!checked; toggleColumn(cb.dataset.col,!checked); }});
      document.getElementById('selectAll').checked=false;
    });
  }
  Object.keys(visibleColumns).forEach(i=>toggleColumn(i, visibleColumns[i]));
}

function toggleColumn(colIndex, visible){
  visibleColumns[colIndex]=visible;
  const headerName=(currentData[0][colIndex]??'').toString().trim();
  columnVisibilityMemory[headerName]=visible;
  const table=document.getElementById('csvTable');
  if(!table) return;
  table.querySelectorAll('tr').forEach(row=>{ const cell=row.children[colIndex]; if(cell) cell.style.display=visible?'':'none'; });
}

// === D√©tection type + Tri ===
function detectType(val){ if(!isNaN(val) && val!=='') return 'number'; const d=new Date(val); if(!isNaN(d.getTime())) return 'date'; return 'string'; }
function sortTable(colIndex){
  const header=currentData[0], body=currentData.slice(1), type=detectType(body.find(r=>r[colIndex]!=null)?.[colIndex]??'');
  body.sort((a,b)=>{
    let valA=a[colIndex]??'', valB=b[colIndex]??'';
    if(type==='number') return sortAsc? valA-valB: valB-valA;
    if(type==='date') return sortAsc? new Date(valA)-new Date(valB): new Date(valB)-new Date(valA);
    valA=valA.toString().toLowerCase(); valB=valB.toString().toLowerCase();
    return sortAsc? valA.localeCompare(valB): valB.localeCompare(valA);
  });
  columnSortMemory.colName=(header[colIndex]??'').toString().trim(); columnSortMemory.asc=sortAsc;
  sortAsc=!sortAsc; sortColIndex=colIndex; currentData=[header,...body];
  renderTable(currentData);
  if(lastSearchQuery!==""){
    document.getElementById("searchInput").value=lastSearchQuery;
    document.querySelectorAll("#csvTable tbody tr").forEach(row=>row.style.display=row.textContent.toLowerCase().includes(lastSearchQuery)?'':'none');
  }
}

// === Recherche ===
document.getElementById("searchInput").addEventListener("input",function(){ 
  lastSearchQuery=this.value.toLowerCase(); 
  document.querySelectorAll("#csvTable tbody tr").forEach(row=>row.style.display=row.textContent.toLowerCase().includes(lastSearchQuery)?'':'none'); 
});

// === R√©initialiser ===
document.getElementById("resetBtn").addEventListener("click",()=>{
  document.getElementById("searchInput").value=""; lastSearchQuery="";
  sortAsc=true; sortColIndex=null; columnSortMemory={colName:null,asc:true}; columnVisibilityMemory={};
  if(currentData.length>0){ currentData=[currentData[0], ...currentData.slice(1)]; visibleColumns={}; renderTable(currentData); }
  const tableContainer=document.getElementById("tableContainer"); tableContainer.classList.remove("flash-red"); void tableContainer.offsetWidth; tableContainer.classList.add("flash-red");
});

// === Export Excel ===
document.getElementById("exportExcel").addEventListener("click",()=> {
  if(currentData.length===0) return;
  let csvName=(document.getElementById('fileName').textContent||'').replace(/\.csv$/i,"");
  let excelFileName=csvName+".xlsx";
  const match=csvName.match(/^SA(\d+)_([0-9]{8})$/);
  if(match){
    const numRaw=match[1]; const numTwoDigits=parseInt(numRaw,10).toString().padStart(2,"0"); 
    const dateRaw=match[2]; excelFileName=`S√©choir-${numTwoDigits}_${dateRaw}.xlsx`;
  }
  const ws=XLSX.utils.aoa_to_sheet(currentData);
  const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Sheet1"); XLSX.writeFile(wb,excelFileName);
});

// === Export PDF ===
document.getElementById("exportPDF").addEventListener("click",()=>{ 
  if(currentData.length===0) return;
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:"l", unit:"pt", format:"a4"});
  const title = (document.getElementById('fileName').textContent||"Tra√ßabilit√© S√©choir");
  doc.setFontSize(14); doc.text(title, 40, 40);
  const body = currentData.slice(1).map(r=>r.map(c=>String(c??"")));
  const head = [currentData[0].map(c=>String(c??""))];
  doc.autoTable({ head, body, startY:60, styles:{fontSize:8, cellPadding:3}, headStyles:{fillColor:[255,112,67]} });
  doc.save(title.replace(/\.csv$/i,"")+".pdf");
});

// === Init ===
window.onload=()=>{ 
  const savedTheme=localStorage.getItem("selectedTheme")||"orange"; 
  setTheme(savedTheme); 
  loadCSV(); 
};
</script>
</body>
</html>














