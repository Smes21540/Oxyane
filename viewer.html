<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Tra√ßabilit√© S√©choir</title>
<style>
body { font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; background-color: #fff0e5; margin: 0; padding: 5px 20px 7px 20px; color: #d84315; font-size: 14px; }
.header { position: relative; display: flex; align-items: center; justify-content: center; margin: 0 0 10px 0; }
.header .logo { height: 60px; width: auto; }
#fileNameContainer { position: absolute; right: 0; top: 0; text-align: right; }
#fileName, #lineCount { color: #d84315; }
#fileName { font-size: 24px; font-weight: bold; white-space: nowrap; max-width: 300px; overflow: hidden; text-overflow: ellipsis; display: none; }
#lineCount { font-size: 12px; display: none; }
.controls, #columnToggles { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin: 5px 0; }
button { background-color: #ff7043; color: white; border: none; cursor: pointer; font-weight: bold; padding: 8px 12px; border-radius: 6px; font-size: 13px; transition: background-color 0.3s ease, transform 0.2s ease; }
button:hover { background-color: #e64a19; transform: scale(1.05); }
#toggleColumnsBtn { padding: 6px 10px; border-radius: 6px; border: 1px solid #e64a19; background-color: #ff7043; color: white; cursor: pointer; font-size: 13px; }
#toggleColumnsBtn:hover { background-color: #e64a19; }
#tableWrapper { text-align: center; flex: 1; overflow:auto; }
#tableContainer { display: inline-block; overflow: auto; max-height: calc(100vh - 180px); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); background: #fff0e5; text-align: center; }
table { width: auto; border-collapse: separate; border-spacing: 0; table-layout: auto; font-size: 13px; }
thead th, tbody td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #ffe5d9; white-space: nowrap; transition: background-color 0.6s ease, color 0.6s ease; }
thead th { position: sticky; top: 0; z-index: 2; background-color: #ff7043; color: white; font-weight: bold; text-transform: uppercase; letter-spacing: 0.05em; cursor: pointer; user-select: none; font-size: 12px; }
thead th:hover { background-color: #e64a19; }
tbody tr:nth-child(even) { background-color: #ffe5d9; }
tbody tr:nth-child(odd) { background-color: #fff0e5; }
tbody tr:hover { background-color: #ffccbc; transition: background-color 0.3s ease; }
thead th.sorted-asc::after { content: " ‚ñ≤"; font-size: 10px; }
thead th.sorted-desc::after { content: " ‚ñº"; font-size: 10px; }
#columnToggles label { font-size: 12px; cursor: pointer; margin-right:5px; }
#columnToggles input[type="checkbox"] { width: 14px; height: 14px; vertical-align: middle; margin-right:3px; }
#columnToggles { display: none; }
.flash-red { animation: flashRed 0.6s ease; }
@keyframes flashRed { 0% { background-color: #ffccbc; } 100% { background-color: #fff0e5; } }
</style>
</head>
<body>

<div class="header">
  <img src="img/logo.png" alt="Logo SMES France" class="logo" />
  <div id="fileNameContainer">
    <div id="fileName"></div>
    <div id="lineCount"></div>
  </div>
</div>

<div class="controls">
  <button id="backBtn">‚¨ÖÔ∏è Retour</button>
  <input type="text" id="searchInput" placeholder="üîé Rechercher..." />
  <button id="exportExcel">üìä Export Excel</button>
  <button id="exportPDF">üìÑ Export PDF</button>
  <button id="toggleColumnsBtn">Afficher/Masquer colonnes</button>
  <button id="resetBtn">‚ôªÔ∏è R√©initialiser affichage</button>
</div>

<div id="columnToggles"></div>
<div id="tableWrapper"><div id="tableContainer"></div></div>

<script src="libs/papaparse.min.js"></script>
<script src="libs/xlsx.full.min.js"></script>
<script src="libs/jspdf.umd.min.js"></script>
<script src="libs/jspdf.plugin.autotable.min.js"></script>
<script>
// === Variables ===
const API_KEY='AIzaSyCbEV3CS9bOcxq5eK-QXbjczGHjvzyXS6M';
let currentData=[], sortAsc=true, sortColIndex=null, visibleColumns={}, columnVisibilityMemory={}, columnSortMemory={colName:null,asc:true}, lastSearchQuery="";

// === Gestion retour ===
document.getElementById('backBtn').addEventListener('click',()=>{ window.close(); });

// === Afficher/Masquer le menu colonnes ===
document.getElementById("toggleColumnsBtn").addEventListener("click", () => {
  const toggles = document.getElementById("columnToggles");
  toggles.style.display = (toggles.style.display === "none" || toggles.style.display === "") 
    ? "flex" 
    : "none";
});

// === R√©cup√©ration CSV via Google Drive ===
function getUrlParam(name){ const params=new URLSearchParams(window.location.search); return params.get(name); }

async function loadCSV(){
  const fileId=getUrlParam('fileId');
  const fileName=getUrlParam('fileName');
  const fileNameDiv=document.getElementById('fileName');
  const lineCountDiv=document.getElementById('lineCount');
  if(!fileId) return;

  fileNameDiv.textContent=fileName||'';
  fileNameDiv.style.display='block';
  lineCountDiv.style.display='block';

  const url=`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media&key=${API_KEY}`;
  const response=await fetch(url);
  const blob=await response.blob();
  const arrayBuffer=await blob.arrayBuffer();
  const text=new TextDecoder('windows-1252').decode(arrayBuffer);
  const results=Papa.parse(text,{header:false,skipEmptyLines:true});
  currentData=results.data;
  const rowCount=currentData.length>1?currentData.length-1:0;
  lineCountDiv.textContent=rowCount+" ligne"+(rowCount!==1?"s":"");
  renderTable(currentData);
}

function escapeHtml(str){ return str.replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[m])); }

function renderTable(data){
  let html='<table id="csvTable">';
  if(data.length>0){
    html+='<thead><tr>';
    data[0].forEach((cell,index)=>{
      let cls=(index===sortColIndex)?(sortAsc?"sorted-desc":"sorted-asc"):"";
      html+=`<th class="${cls}" onclick="sortTable(${index})">${escapeHtml((cell??'').toString().trim())}</th>`;
    });
    html+='</tr></thead>';
  }
  html+='<tbody>';
  for(let i=1;i<data.length;i++){
    html+='<tr>';
    data[i].forEach((cell,index)=> html+=`<td>${escapeHtml((cell??'').toString().trim())}</td>`);
    html+='</tr>';
  }
  html+='</tbody></table>';
  document.getElementById('tableContainer').innerHTML=html;

  const toggleContainer=document.getElementById('columnToggles');
  toggleContainer.innerHTML=`<label style="font-weight:bold;"><input type="checkbox" id="selectAll" /> Tout</label>
                             <label style="font-weight:bold;"><input type="checkbox" id="selectNone" /> Aucune</label>`;
  if(data.length>0){
    data[0].forEach((cell,index)=>{
      const colName=(cell??'').toString().trim(), id=`colToggle${index}`, checked=columnVisibilityMemory[colName]!==false;
      visibleColumns[index]=checked;
      toggleContainer.innerHTML+=`<label><input type="checkbox" id="${id}" data-col="${index}" ${checked?"checked":""} /> ${escapeHtml(colName)}</label>`;
    });
    toggleContainer.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
      const colIndex=cb.dataset.col;
      if(colIndex!==undefined) cb.addEventListener('change',()=>toggleColumn(colIndex, cb.checked));
    });
    document.getElementById('selectAll').addEventListener('change',e=>{
      const checked=e.target.checked;
      document.querySelectorAll('#columnToggles input[type="checkbox"]').forEach(cb=>{ if(cb.dataset.col!==undefined){ cb.checked=checked; toggleColumn(cb.dataset.col, checked); }});
      document.getElementById('selectNone').checked=false;
    });
    document.getElementById('selectNone').addEventListener('change',e=>{
      const checked=e.target.checked;
      document.querySelectorAll('#columnToggles input[type="checkbox"]').forEach(cb=>{ if(cb.dataset.col!==undefined){ cb.checked=!checked; toggleColumn(cb.dataset.col,!checked); }});
      document.getElementById('selectAll').checked=false;
    });
  }
  Object.keys(visibleColumns).forEach(i=>toggleColumn(i, visibleColumns[i]));
}

function toggleColumn(colIndex, visible){
  visibleColumns[colIndex]=visible;
  const headerName=(currentData[0][colIndex]??'').toString().trim();
  columnVisibilityMemory[headerName]=visible;
  const table=document.getElementById('csvTable');
  if(!table) return;
  table.querySelectorAll('tr').forEach(row=>{ const cell=row.children[colIndex]; if(cell) cell.style.display=visible?'':'none'; });
}

function detectType(val){
  if(!isNaN(val) && val!=='') return 'number';
  const d=new Date(val);
  if(!isNaN(d.getTime())) return 'date';
  return 'string';
}

function sortTable(colIndex){
  const header=currentData[0], body=currentData.slice(1), type=detectType(body.find(r=>r[colIndex]!=null)?.[colIndex]??'');
  body.sort((a,b)=>{
    let valA=a[colIndex]??'', valB=b[colIndex]??'';
    if(type==='number') return sortAsc? valA-valB: valB-valA;
    if(type==='date') return sortAsc? new Date(valA)-new Date(valB): new Date(valB)-new Date(valA);
    valA=valA.toString().toLowerCase(); valB=valB.toString().toLowerCase();
    return sortAsc? valA.localeCompare(valB): valB.localeCompare(valA);
  });
  columnSortMemory.colName=(header[colIndex]??'').toString().trim(); columnSortMemory.asc=sortAsc;
  sortAsc=!sortAsc; sortColIndex=colIndex; currentData=[header,...body];
  renderTable(currentData);
  if(lastSearchQuery!==""){
    document.getElementById("searchInput").value=lastSearchQuery;
    document.querySelectorAll("#csvTable tbody tr").forEach(row=>row.style.display=row.textContent.toLowerCase().includes(lastSearchQuery)?'':'none');
  }
}

// === Recherche ===
document.getElementById("searchInput").addEventListener("input",function(){ 
  lastSearchQuery=this.value.toLowerCase(); 
  document.querySelectorAll("#csvTable tbody tr").forEach(row=>row.style.display=row.textContent.toLowerCase().includes(lastSearchQuery)?'':'none'); 
});

// === R√©initialiser ===
document.getElementById("resetBtn").addEventListener("click",()=>{
  document.getElementById("searchInput").value=""; lastSearchQuery="";
  sortAsc=true; sortColIndex=null; columnSortMemory={colName:null,asc:true}; columnVisibilityMemory={};
  if(currentData.length>0){ currentData=[currentData[0], ...currentData.slice(1).sort((a,b)=>0)]; visibleColumns={}; renderTable(currentData); }
  const tableContainer=document.getElementById("tableContainer"); tableContainer.classList.remove("flash-red"); void tableContainer.offsetWidth; tableContainer.classList.add("flash-red");
});

// === Export Excel ===
document.getElementById("exportExcel").addEventListener("click",()=> {
  if(currentData.length===0) return;
  let csvName=(document.getElementById('fileName').textContent||'').replace(/\.csv$/i,"");
  let excelFileName=csvName+".xlsx";
  const match=csvName.match(/^SA(\d+)_([0-9]{8})$/);
  if(match){
    const numRaw=match[1]; const numTwoDigits=parseInt(numRaw,10).toString().padStart(2,"0"); 
    const dateRaw=match[2]; excelFileName=`S√©choir-${numTwoDigits}_${dateRaw}.xlsx`;
  }
  const ws=XLSX.utils.aoa_to_sheet(currentData);
  const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Sheet1"); XLSX.writeFile(wb,excelFileName);
});

// === Export PDF ===
document.getElementById("exportPDF").addEventListener("click",()=>{
  if(currentData.length===0) return;
  const { jsPDF }=window.jspdf;
  const doc=new jsPDF({orientation:'landscape'});
  let csvName=(document.getElementById('fileName').textContent||'').replace(/\.csv$/i,"");
  let titleText=csvName; let pdfFileName=csvName+".pdf";

  if(csvName.startsWith("Z")){
    const matchZ=csvName.match(/^Z\d+(\d{2})_\d{8}$/);
    let xx=matchZ?parseInt(matchZ[1],10).toString():"";
    const dateRaw=csvName.match(/\d{8}/)?.[0]??"";
    let dateFormatted="";
    if(dateRaw.length===8){
      const yyyy=dateRaw.substring(0,4), mm=dateRaw.substring(4,6), dd=dateRaw.substring(6,8);
      dateFormatted=`${dd}/${mm}/${yyyy}`;
    }
    titleText=`Historique S√©choir ${xx}`+(dateFormatted?` - ${dateFormatted}`:"");
    pdfFileName=csvName+".pdf";
  } else {
    const match=csvName.match(/^SA(\d+)_([0-9]{8})$/);
    if(match){
      const numRaw=match[1], numNoZero=parseInt(numRaw,10).toString();
      const numTwoDigits=numNoZero.padStart(2,"0");
      const dateRaw=match[2]; const yyyy=dateRaw.substring(0,4), mm=dateRaw.substring(4,6), dd=dateRaw.substring(6,8);
      const dateFormatted=`${dd}/${mm}/${yyyy}`;
      titleText=parseInt(numRaw)>0?`S√©choir ${numNoZero} - ${dateFormatted}`:dateFormatted;
      pdfFileName=parseInt(numRaw)>0?`S√©choir-${numTwoDigits}_${dateRaw}.pdf`:`${dateRaw}.pdf`;
    }
  }

  const head=currentData[0].filter((_,i)=>visibleColumns[i]!==false);
  const body=currentData.slice(1).map(row=>row.filter((_,i)=>visibleColumns[i]!==false));
  const rowCount=body.length;
  const pageHeight=doc.internal.pageSize.height, pageWidth=doc.internal.pageSize.width;
  const marginTop=15, marginBottom=10, usableHeight=pageHeight-marginTop-marginBottom;
  const maxLinesPerPage=100, rowHeight=Math.max(4,usableHeight/maxLinesPerPage);
  let fontSize=Math.floor(rowHeight*0.6); fontSize=Math.max(5,Math.min(8,fontSize));
  let cellPadding=Math.floor(rowHeight*0.15); cellPadding=Math.max(1,cellPadding);

  doc.setFontSize(14); doc.setTextColor(255,112,67);
  const titleLines=doc.splitTextToSize(titleText,pageWidth-20);
  doc.text(titleLines,14,12);

  const autoTableOptions={
    head:[head],
    body:body,
    styles:{fontSize,fontPadding:cellPadding,cellPadding,valign:'middle'},
    headStyles:{fillColor:[255,112,67],textColor:[255,255,255],fontStyle:'bold'},
    alternateRowStyles:{fillColor:[255,229,217]},
    bodyStyles:{textColor:[50,50,50]},
    margin:{top:15+titleLines.length*5,left:10,right:10},
    tableWidth:'auto',
    rowPageBreak:'auto',
    showHead:'everyPage'
  };

  let totalPages=1;
  if(rowCount>=30){
    const tmpDoc=new jsPDF({orientation:'landscape'});
    tmpDoc.autoTable(autoTableOptions);
    totalPages=tmpDoc.internal.getNumberOfPages();
    autoTableOptions.didDrawPage=(data)=>{
      const pageCount=doc.internal.getNumberOfPages();
      doc.setFontSize(8); doc.setTextColor(100);
      doc.text("Page "+pageCount+" / "+totalPages,pageWidth-20,pageHeight-5);
    };
  }

  doc.autoTable(autoTableOptions);
  doc.save(pdfFileName);
});

// === Chargement CSV au d√©marrage ===
window.onload=loadCSV;
</script>
</body>
</html>




