<!DOCTYPE html>
<html lang="fr">
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-YG4RV4W27S"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-YG4RV4W27S');
</script>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Explorateur donn√©es s√©choirs</title>

<!-- D√©pendances -->
<script src="libs/jszip.min.js"></script>
<script src="libs/FileSaver.min.js"></script>

<style>
:root{
  --bg:#fff5f5;
  --panel:#ffffff;
  --sidebar-bg:#ffe5d9;
  --text:#333;
  --muted-text:#555;
  --shadow:rgba(0,0,0,0.1);
  --overlay:rgba(0,0,0,0.8);
  --table-border:#eee;
  --thumb-border:#ccc;

  /* Th√®me (orange par d√©faut) */
  --accent:#ff7043;
  --accent-contrast:#fff;
  --accent-darker:#e64a19;
  --accent-muted:#ffccbc;
  --danger:#d84315;

  /* Couleurs des lignes du tableau */
  --row-even:#ffe5d9;
  --row-odd:#fff5f5;
}

*{box-sizing:border-box}

body{
  font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;
  background:var(--bg);color:var(--text);margin:0;padding:0;
  display:flex;height:100vh;overflow:hidden;
}

/* Alerte r√©seau */
#netAlert{
  display:none;position:fixed;top:0;left:0;right:0;z-index:3000;
  background:var(--accent-muted);color:var(--danger);
  padding:8px;text-align:center;font-weight:bold;
}

/* Sidebar */
#sidebar{
  background:var(--sidebar-bg);border-right:2px solid var(--accent);
  padding:20px 10px;overflow-y:auto;z-index:1000;
  width:auto;min-width:200px;max-width:500px;
}
#sidebar h2{
  color:var(--accent);font-size:18px;font-weight:bold;text-transform:uppercase;
  margin:0 0 12px 0;padding-left:5px;display:flex;align-items:center;gap:6px;
}
#folderTree ul{list-style:none;padding-left:20px;margin:0;}
#folderTree li{cursor:pointer;margin:5px 0;}
.folder-toggle{font-weight:bold;margin-right:5px;cursor:pointer;color:var(--accent);}
.folder-name{cursor:pointer;}
.active-folder {
  background: var(--accent-muted);
  border-left: 2px solid var(--accent);
  border-radius: 3px;
  padding: 1px 4px;
  font-weight: 600;
  color: var(--accent-darker);
  box-shadow: none;
}



/* Main */
#main{flex:1;padding:10px 20px;display:flex;flex-direction:column;overflow:hidden;}
.header{display:flex;align-items:center;justify-content:center;position:relative;margin-bottom:15px;}
.header .logo{height:60px;width:auto;}
#fileNameContainer{position:absolute;right:0;top:0;text-align:right;}
#fileName,#lineCount{color:var(--danger);}
#fileName{font-size:20px;font-weight:bold;white-space:nowrap;max-width:250px;overflow:hidden;text-overflow:ellipsis;display:none;}
#lineCount{font-size:12px;display:none;}

/* Contr√¥les */
.controls{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:10px;align-items:center;}
.controls button{
  background:var(--accent);color:var(--accent-contrast);
  border:none;cursor:pointer;font-weight:bold;
  padding:6px 12px;border-radius:6px;font-size:13px;transition:0.3s;
}
.controls button:hover{background:var(--accent-darker);transform:scale(1.05);}

/* Champs date + ic√¥ne custom */
.date-field{
  display:flex;align-items:center;gap:6px;background:var(--panel);
  border:2px solid var(--table-border);border-radius:6px;padding:4px 8px;
}
.date-field span{font-size:16px;color:var(--accent);cursor:pointer;user-select:none;transition:0.2s;}
.date-field span:hover{transform:scale(1.2);}
.date-field input[type=date]{border:none;outline:none;background:transparent;font-size:14px;color:var(--text);padding:6px 2px;}
input[type="date"]::-webkit-calendar-picker-indicator{display:none;-webkit-appearance:none;}
.date-field input[type=date]:focus {box-shadow:0 0 6px var(--accent);border-color:var(--accent);color:var(--danger);}

/* Tableau */
#tableWrapper{flex:1;overflow:auto;}
#tableContainer{overflow:auto;border-radius:8px;box-shadow:0 4px 12px var(--shadow);background:var(--panel);}
table{border-collapse:separate;border-spacing:0;width:100%;font-size:13px;}
thead th,tbody td{padding:10px 12px;text-align:left;border-bottom:1px solid var(--table-border);white-space:nowrap;}
thead th{
  position:sticky;top:0;z-index:2;background:var(--accent);
  color:var(--accent-contrast);font-weight:bold;text-transform:uppercase;cursor:pointer;
}
tbody tr:nth-child(even){background:var(--row-even);}
tbody tr:nth-child(odd){background:var(--row-odd);}
tbody tr:hover{background:var(--accent-muted);}
.sort-arrow{margin-left:5px;font-size:11px;color:var(--accent-contrast);}

/* Cellule actions + boutons survol */
td.action-cell{display:flex;align-items:center;gap:8px;}
.action-btn{
  background:var(--accent);color:var(--accent-contrast);border:none;cursor:pointer;
  font-weight:bold;padding:6px 12px;border-radius:6px;font-size:12px;transition:0.2s;
  margin-right:6px;opacity:0;visibility:hidden;
}
tbody tr:hover .action-btn{opacity:1;visibility:visible;}
.action-btn:hover{background:var(--accent-darker);transform:scale(1.05);}

/* Miniatures JPG */
#csvTable td img{
  max-width:120px;
  cursor:pointer;border-radius:6px;border:1px solid var(--thumb-border);
  transition:transform 0.2s,box-shadow 0.2s;margin-right:6px;
}
#csvTable td img:hover{transform:scale(1.08);box-shadow:0 0 8px var(--shadow);}

/* Fl√®che anim√©e */
@keyframes bounceLeft {0%,100% { transform: translateX(0);}50% { transform: translateX(-8px);} }
.arrow-hint {display:inline-block;margin-right:8px;color:var(--accent-darker);
  font-size:22px;animation:bounceLeft 1s infinite;}

/* Spinner */
#spinner{
  display:none;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  width:40px;height:40px;border:6px solid #f3f3f3;border-top:6px solid var(--accent);border-radius:50%;
}

/* Modale images */
.modal{display:none;position:fixed;z-index:1300;padding-top:50px;left:0;top:0;width:100%;height:100%;background-color:var(--overlay);text-align:center;}
.modal .close{position:absolute;top:15px;right:25px;color:#fff;font-size:30px;cursor:pointer;}
.modal iframe{width:90%;height:80vh;border:none;border-radius:10px;background:#000;}
.modal-actions{margin-top:15px;display:flex;justify-content:center;gap:10px;}
.modal-actions button{background:var(--accent);color:#fff;border:none;padding:8px 16px;border-radius:5px;cursor:pointer;font-weight:bold;}
.modal-actions button:hover{background:var(--accent-darker);}

/* Overlay ZIP */
#zipOverlay{
  display:none;position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.4);z-index:1400;justify-content:center;align-items:center;
}
#zipBox{
  background:var(--accent-muted);color:var(--text);padding:20px 25px;border-radius:12px;
  text-align:center;width:300px;box-shadow:0 4px 12px rgba(0,0,0,0.3);position:relative;
}
#zipBox h2{margin:0 0 10px 0;color:var(--accent);font-size:18px;}
#zipFileName{font-size:13px;margin-bottom:15px;color:var(--muted-text);word-break:break-word;}
#zipProgressBar{width:100%;height:22px;background:#eee;border-radius:11px;overflow:hidden;}
#zipProgress{
  height:100%;width:0;background:var(--accent);transition:width 0.3s;
  display:flex;align-items:center;justify-content:center;color:#fff;font-weight:bold;font-size:13px;
}
#zipCounter{margin-top:10px;font-size:12px;color:var(--text);}
#zipTime{margin-top:5px;font-size:12px;color:var(--muted-text);}
#zipClose{
  position:absolute;top:8px;right:12px;font-size:18px;font-weight:bold;color:var(--accent);cursor:pointer;
}
#zipClose:hover{color:var(--accent-darker);}

/* Menu secret (th√®mes) */
#secretBtn {
  position: fixed;bottom: 10px;right: 10px;width: 25px;height: 25px;
  opacity: 0;cursor: pointer;z-index: 2000;
}
#themeMenu {
  display:none;position:fixed;bottom:50px;right:10px;background: var(--panel);
  border:2px solid var(--accent);border-radius:8px;box-shadow:0 4px 12px var(--shadow);
  padding:10px;z-index:2001;min-width:150px;
}
#themeMenu h3 {margin:0 0 8px 0;font-size:14px;color: var(--accent);}
#themeMenu .closeMenu {position:absolute;top:5px;right:8px;font-size:14px;cursor:pointer;color:var(--accent);}
#themeMenu .closeMenu:hover {color:var(--accent-darker);}
#themeMenu button {
  display:block;width:100%;margin:4px 0;padding:6px;border:none;border-radius:6px;
  background: var(--accent);color: var(--accent-contrast);cursor:pointer;font-size:13px;
}
#themeMenu button:hover {background: var(--accent-darker);}
.flame {
  display: flex;                /* permet de centrer facilement */
  justify-content: center;      /* horizontalement */
  align-items: center;          /* verticalement */
  font-size: 22px;              /* taille de la flamme */
  line-height: 1;
  animation: flicker 0.6s infinite alternate,
             sway 1.2s infinite ease-in-out; /* mouvement lat√©ral doux */
  text-shadow:
    0 0 4px rgba(255, 140, 0, 0.8),
    0 0 8px rgba(255, 80, 0, 0.7),
    0 0 12px rgba(255, 30, 0, 0.5);
}

/* Petite flamme pour les dossiers dans l‚Äôarborescence */
.flame-folder {
  display: inline;               
  font-size: 14px;               
  margin-right: 4px;             
  line-height: 1;                
  vertical-align: middle;
  text-shadow: 
    0 0 3px rgba(255, 140, 0, 0.8),
    0 0 6px rgba(255, 80, 0, 0.7);
  animation: flicker 1s infinite alternate;
}
  

@keyframes sway {
  0%, 100% { transform: translateX(0); }
  50% { transform: translateX(3px) rotate(3deg); }
}


#eventAlert {
  display:none;
  position:fixed;
  top:40px; /* juste sous netAlert */
  left:50%;
  transform:translateX(-50%);
  background:var(--accent);
  color:#fff;
  padding:8px 16px;
  border-radius:6px;
  font-weight:bold;
  z-index:3000;
  box-shadow:0 2px 8px rgba(0,0,0,0.2);
}


</style>
</head>
<body>

<div id="netAlert">‚ö†Ô∏è Pas de connexion internet d√©tect√©e. V√©rifiez votre r√©seau.</div>
<div id="eventAlert">‚úÖ √âv√©nements charg√©s</div>
<div id="spinner"></div>


<!-- Sidebar dossiers -->
<div id="sidebar">
  <h2><span>üìÅ</span>Dossiers</h2>
  <ul id="folderTree"></ul>
</div>

<!-- Main -->
<div id="main">
  <div class="header">
    <img src="img/logo.png" class="logo" id="mainLogo" alt="Logo"/>
    <div id="fileNameContainer">
      <div id="fileName"></div>
      <div id="lineCount"></div>
    </div>
  </div>

  <div class="controls">
    Filtrer par date : 
    <div class="date-field"><span id="iconStart">üìÖ</span><input type="date" id="startDate"></div>
    √†
    <div class="date-field"><span id="iconEnd">üìÖ</span><input type="date" id="endDate"></div>
    <button onclick="applyFilter()">Filtrer</button>
    <button onclick="clearFilter()">Tout afficher</button>
    <button id="downloadFolderBtn">T√©l√©charger le dossier</button>
  </div>

  <div id="tableWrapper">
    <div id="tableContainer">
      <table id="csvTable">
<thead>
  <tr>
    <th onclick="sortTable(0,'date')">Date <span class="sort-arrow"></span></th>
    <th style="width:40px; text-align:center;"></th>

    <th>T√©l√©charger / Ouvrir</th>
    <th>Nom du fichier</th>
    <th>Dossier</th>
    <th onclick="sortTable(5,'number')">Taille <span class="sort-arrow"></span></th>
  </tr>
</thead>


        <tbody>
          <tr>
            <td colspan="5" style="text-align:left;">
              <span class="arrow-hint">‚¨Ö</span> S√©lectionner un dossier...
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modale image -->
<div id="imageModal" class="modal" role="dialog" aria-modal="true">
  <span class="close" onclick="closeModal()" aria-label="Fermer">&times;</span>
  <!-- tabindex=-1 pour √©viter que l'iframe vole le focus / bloque les fl√®ches -->
  <iframe id="modalFrame" tabindex="-1"></iframe>
  <div class="modal-actions">
    <button id="prevBtn">&larr; Pr√©c√©dent</button>
    <button id="nextBtn">Suivant &rarr;</button>
    <button id="downloadBtn">T√©l√©charger</button>
  </div>
</div>

<!-- Overlay ZIP -->
<div id="zipOverlay">
  <div id="zipBox">
    <span id="zipClose">&times;</span>
    <h2>Pr√©paration du ZIP...</h2>
    <div id="zipFileName"></div>
    <div id="zipProgressBar"><div id="zipProgress">0%</div></div>
    <div id="zipCounter">0 / 0 fichiers</div>
    <div id="zipTime">Temps restant : --</div>
  </div>
</div>

<!-- Bouton secret + menu th√®mes -->
<div id="secretBtn" title=" "></div>
<div id="themeMenu">
  <span class="closeMenu" onclick="closeThemeMenu()">‚ùå</span>
  <h3>Choisir un th√®me</h3>
  <button onclick="setTheme('orange')">Orange (d√©faut)</button>
  <button onclick="setTheme('blue')">Bleu</button>
  <button onclick="setTheme('green')">Vert</button>
  <button onclick="setTheme('purple')">Violet</button>
  <button onclick="setTheme('bordeaux')">Bordeaux</button>
</div>

<script>
/* ----------- Config Drive ----------- */
const ROOT_FOLDER_ID="18QkQPyCZxTCAaoz_qd1wAelmQbSE4ex8";

/* ----------- Config personnalis√©e ----------- */
const FLAME_THRESHOLD = 40.0;   // seuil d√©clencheur de la flamme üî•

/* ----------- √âtat ----------- */
let imageFiles=[], currentImageIndex=0;
let filterStartDate="", filterEndDate="";
let themeMenuTimer;
let cancelScan = false; // üõë permet d‚Äôarr√™ter le scan si on clique ailleurs


/* ----------- Utilitaires UI ----------- */
const spinner=document.getElementById('spinner');
function showSpinner(){spinner.style.display='block';}
function hideSpinner(){spinner.style.display='none';}

function updateNetworkStatus(){
  document.getElementById("netAlert").style.display = navigator.onLine ? "none" : "block";
}
window.addEventListener("online",updateNetworkStatus);
window.addEventListener("offline",updateNetworkStatus);

function formatSize(bytes){
  if(!bytes) return "?";
  const units=["o","Ko","Mo","Go"]; let i=0; let v=Number(bytes);
  while(v>=1024 && i<units.length-1){ v/=1024; i++; }
  return (i===0?Math.round(v):v.toFixed(1))+" "+units[i];
}

function showEventAlert(msg="‚úÖ √âv√©nements charg√©s") {
  const alertBox = document.getElementById("eventAlert");
  alertBox.textContent = msg;
  alertBox.style.display = "block";
  setTimeout(()=>{ alertBox.style.display="none"; },2000);
}


/* ----------- Drive API ----------- */
async function fetchFolderContents(folderId){
  if(!navigator.onLine){updateNetworkStatus();return [];}
  showSpinner();
  try{
    const res = await fetch(`https://smes21540.netlify.app/.netlify/functions/drive?list=true&id=${folderId}&site=Smes_Acces`);

    // üö´ Blocage abonnement
    if (res.status === 403) {
      alert("‚õî Acc√®s suspendu : merci de r√©gulariser votre abonnement.");
      hideSpinner();
      return [];
    }

    // üîé Autre erreur HTTP
    if (!res.ok) {
      console.error("Erreur proxy Drive:", res.status, res.statusText);
      alert("Erreur r√©seau ou proxy. V√©rifie ta connexion ou ton acc√®s.");
      hideSpinner();
      return [];
    }

    // ‚úÖ Lecture JSON si tout va bien
    const data = await res.json();
    if (data.error) {
      console.error("Erreur Google Drive API:", data.error);
      alert("Erreur Drive (proxy). Ouvre la console pour le d√©tail.");
      hideSpinner();
      return [];
    }

    return data.files || [];

  } catch(e){
    console.error("Erreur Drive:", e);
    alert("Erreur interne ou blocage d‚Äôacc√®s (proxy).");
    return [];
  } finally{
    hideSpinner();
  }
}




async function loadRootFolders(){
  const files = await fetchFolderContents(ROOT_FOLDER_ID);
  const rootUL = document.getElementById('folderTree');
  rootUL.innerHTML = '';

  files
  .filter(f => f.mimeType === 'application/vnd.google-apps.folder')
  .sort((a,b) => a.name.localeCompare(b.name, 'fr', { sensitivity:'base' }))
  .forEach(f => {

    const li = document.createElement('li'); 
    li.dataset.id = f.id;

    const toggle = document.createElement('span'); 
    toggle.className = 'folder-toggle'; 
    toggle.textContent = '+';
    toggle.onclick = () => toggleFolder(li);

const span = document.createElement('span');
span.className = 'folder-name';

const lowerName = f.name.toLowerCase();
if (lowerName.includes("tra√ßa_temp") || lowerName.includes("traca_temp")) {
  span.innerHTML = `üìà ${f.name}`;
} else if (lowerName.includes("echantillonnage")) {
  span.innerHTML = `üìä ${f.name}`;
} else if (lowerName.includes("historique")) {
  span.innerHTML = `üóÇÔ∏è ${f.name}`;
} else {
  span.textContent = f.name; // pas d‚Äôic√¥ne
}


span.onclick = () => loadFolderFilesOnClick(li);




    li.appendChild(toggle); 
    li.appendChild(span); 
    rootUL.appendChild(li);
  });

  // üî• V√©rifier automatiquement deux crans plus bas sans ouvrir visuellement
  setTimeout(async () => {
    const siteFolders = document.querySelectorAll("#folderTree > li");

    for (const siteLi of siteFolders) {
      const subFolders = await fetchChildren(siteLi.dataset.id);
      for (const sub of subFolders) {
        if (sub.name.includes("Temp")) {
          await checkTra√ßaTempToday(siteLi, sub.id); 
        }
      }
    }
  }, 1000);
}

async function toggleFolder(li){
  const toggle=li.querySelector('.folder-toggle');
  if(li.dataset.loaded==='true'){
    const ul=li.querySelector('ul');
    if(ul){ul.style.display=ul.style.display==='none'?'block':'none'; toggle.textContent=ul.style.display==='block'?'‚Äì':'+';}
    return;
  }
  toggle.textContent='‚Ä¶';
  const files=await fetchFolderContents(li.dataset.id);
  const ul=document.createElement('ul');
  const folders = files
  .filter(f => f.mimeType === 'application/vnd.google-apps.folder')
  .sort((a,b) => a.name.localeCompare(b.name, 'fr', { sensitivity:'base' }));

for (const f of folders) {

    const childLi=document.createElement('li'); 
    childLi.dataset.id=f.id;

    const childToggle=document.createElement('span'); 
    childToggle.className='folder-toggle'; 
    childToggle.textContent='+';
    childToggle.onclick=()=>toggleFolder(childLi);

const span = document.createElement('span');
span.className = 'folder-name';

const lowerName = f.name.toLowerCase();
if (lowerName.includes("tra√ßa_temp") || lowerName.includes("traca_temp")) {
  span.innerHTML = `üìà ${f.name}`;
} else if (lowerName.includes("echantillonnage")) {
  span.innerHTML = `üìä ${f.name}`;
} else if (lowerName.includes("historique")) {
  span.innerHTML = `üóÇÔ∏è ${f.name}`;
} else {
  span.textContent = f.name;
}

span.onclick = () => loadFolderFilesOnClick(childLi);


    childLi.appendChild(childToggle); 
    childLi.appendChild(span); 
    ul.appendChild(childLi);

    // ‚úÖ Cas sp√©cial : si le dossier est Tra√ßa_Temp ‚Üí pr√©charger Historique
    if (f.name.toLowerCase().includes("tra√ßa_temp") || f.name.toLowerCase().includes("traca_temp")) {
      const siblings = await fetchFolderContents(li.dataset.id);
      const hist = siblings.find(s => s.mimeType === 'application/vnd.google-apps.folder' && s.name.toLowerCase().includes("historique"));
      if (hist) {
        const histFiles = await fetchFolderContents(hist.id);
        const z3Files = histFiles.filter(ff => ff.name.toUpperCase().startsWith("Z3") && ff.name.toLowerCase().endsWith(".csv"));
localStorage.setItem("csvZ3Files", JSON.stringify(z3Files));
console.log("[Z3] Pr√©charg√©s depuis Historique:", z3Files.length);
showEventAlert();

      }
    }

    // ‚úÖ V√©rif Temp (flamme üî•)
    if(f.name.includes("Temp")){ checkTra√ßaTempToday(li, f.id); }
  }
  li.appendChild(ul); 
  li.dataset.loaded='true'; 
  toggle.textContent='+';
}


// Fonction utilitaire pour r√©cup√©rer les sous-dossiers sans modifier l'affichage
async function fetchChildren(folderId){
  const files = await fetchFolderContents(folderId);
  return files.filter(f => f.mimeType === 'application/vnd.google-apps.folder');
}

async function loadFolderFilesOnClick(li){
  await toggleFolder(li);

// üîÑ R√©initialiser la s√©lection visuelle
document.querySelectorAll('#folderTree li span.folder-name').forEach(s => s.classList.remove('active-folder'));

// ‚úÖ Surligne le dossier cliqu√©
const nameSpan = li.querySelector('span.folder-name');
if (nameSpan) nameSpan.classList.add('active-folder');

// ‚úÖ Surligne aussi tous les parents (chemin hi√©rarchique)
let parentLi = li.parentElement.closest('li');
while (parentLi) {
  const parentSpan = parentLi.querySelector('span.folder-name');
  if (parentSpan) parentSpan.classList.add('active-folder');
  parentLi = parentLi.parentElement.closest('li');
}

  localStorage.setItem('lastFolderId', li.dataset.id);

// üìÇ Sauvegarde du chemin complet (ex: Voreppe/Tra√ßa_Temp)
function buildFullFolderPath(li) {
  const parts = [];
  let current = li;
  while (current) {
    const nameSpan = current.querySelector(".folder-name");
    if (nameSpan) parts.unshift(nameSpan.textContent.trim());
    current = current.parentElement.closest("li");
  }
  return parts.join("/");
}

const fullPath = buildFullFolderPath(li);
localStorage.setItem("lastFolderPath", fullPath);
console.log("[Folder] Chemin complet enregistr√© :", fullPath);

  
  const folderName = nameSpan ? nameSpan.textContent.toLowerCase() : "";

  // ‚ö° Gestion sp√©ciale Z3
  if (folderName.includes("tra√ßa_temp") || folderName.includes("traca_temp")) {
    // r√©cup√©rer le dossier parent (= site)
    const siteLi = li.parentElement.closest("li");
    if (siteLi && siteLi.dataset.id) {
      const siblings = await fetchFolderContents(siteLi.dataset.id);
      const hist = siblings.find(s => 
        s.mimeType === 'application/vnd.google-apps.folder' && 
        s.name.toLowerCase().includes("historique")
      );

      if (hist) {
        const histFiles = await fetchFolderContents(hist.id);
        const z3Files = histFiles.filter(ff => 
          ff.name.toUpperCase().startsWith("Z3") && 
          ff.name.toLowerCase().endsWith(".csv")
        );
        localStorage.setItem("csvZ3Files", JSON.stringify(z3Files));
        console.log("[Z3] Pr√©charg√©s depuis Historique voisin:", z3Files.length);
      } else {
        localStorage.removeItem("csvZ3Files");
        console.warn("[Z3] Aucun dossier Historique trouv√© pour", nameSpan.textContent);
      }
    }
  } 
  else if (folderName.includes("historique")) {
    // directement charger les Z3 de ce dossier
    const histFiles = await fetchFolderContents(li.dataset.id);
    const z3Files = histFiles.filter(ff => 
      ff.name.toUpperCase().startsWith("Z3") && 
      ff.name.toLowerCase().endsWith(".csv")
    );
    localStorage.setItem("csvZ3Files", JSON.stringify(z3Files));
    console.log("[Z3] Pr√©charg√©s directement (Historique):", z3Files.length);
  } 
  else {
    // Sinon ‚Üí effacer le cache Z3
    localStorage.removeItem("csvZ3Files");
    console.log("[Z3] Cache vid√© (hors Tra√ßa_Temp / Historique)");
  }

  // Charger fichiers CSV/JPG classiques du dossier
  const files = await fetchFolderContents(li.dataset.id);
  const filtered = files.filter(f => 
    f.name.toLowerCase().endsWith('.csv') || 
    f.name.toLowerCase().endsWith('.jpg') || 
    f.name.toLowerCase().endsWith('.jpeg')
  );





// üß≠ D√©termination du site courant
const siteLi = li.parentElement.closest("li");
let siteId = siteLi?.dataset.id || null;

if (siteId && siteId !== currentSiteId) {
  clearSiteHotDays();
  currentSiteId = siteId;
  console.log(`[SITE] Changement de site ‚Üí ${siteLi.querySelector(".folder-name")?.textContent}`);
  
// üî• Lancer le scan en arri√®re-plan sans bloquer l'affichage
scanSiteHotDays(siteId).then(map => {
  hotDaysMap = map;
  console.log(`[CACHE] üî• ${Object.keys(hotDaysMap).length} jours chauds d√©tect√©s et charg√©s pour ${siteLi.querySelector(".folder-name")?.textContent}`);

  // ü™Ñ Rafra√Æchir seulement les flammes dans le tableau actuel
  document.querySelectorAll('#csvTable tbody tr').forEach(tr => {
    const nameCell = tr.cells[3]; // colonne Nom du fichier
    const flameCell = tr.cells[1]; // colonne flamme
    if (!nameCell || !flameCell) return;

    const fname = nameCell.textContent.trim();
    const m = fname.match(/(\d{8})\.csv$/i);
    if (m && hotDaysMap[m[1]]) {
      flameCell.innerHTML = `<span class="flame" title="Br√ªleur actif ce jour-l√†">üî•</span>`;
    }
  });
});

} else if (siteId && Object.keys(hotDaysMap).length === 0) {
  hotDaysMap = loadSiteHotDays(siteId);
  if (Object.keys(hotDaysMap).length === 0) {
    console.log(`[CACHE] Aucun cache trouv√© pour ${siteLi.querySelector(".folder-name")?.textContent}, relance du scan...`);
    scanSiteHotDays(siteId).then(map => {
      hotDaysMap = map;
      console.log(`[CACHE] üî• ${Object.keys(hotDaysMap).length} jours chauds d√©tect√©s et charg√©s pour ${siteLi.querySelector(".folder-name")?.textContent}`);
      const active = document.querySelector('#folderTree .active-folder');
      if (active) active.click();
    });
  } else {
    console.log(`[CACHE] ${Object.keys(hotDaysMap).length} jours chauds charg√©s depuis cache`);
  }
}

imageFiles = filtered.filter(f => /\.(jpg|jpeg)$/i.test(f.name)); 
displayFiles(filtered, nameSpan ? nameSpan.textContent : '');


// ü™Ñ Applique imm√©diatement les flammes du cache si d√©j√† charg√© pour ce site
if (Object.keys(hotDaysMap).length > 0) {
  document.querySelectorAll('#csvTable tbody tr').forEach(tr => {
    const nameCell = tr.cells[3]; // colonne Nom du fichier
    const flameCell = tr.cells[1]; // colonne flamme
    if (!nameCell || !flameCell) return;

    const m = nameCell.textContent.match(/(\d{8})\.csv$/i);
    if (m && hotDaysMap[m[1]]) {
      flameCell.innerHTML = `<span class="flame" title="Br√ªleur actif ce jour-l√†">üî•</span>`;
    }
  });
}



function displayFiles(files, folderName){
  const tbody=document.querySelector('#csvTable tbody');
  const downloadBtn=document.getElementById('downloadFolderBtn');
  tbody.innerHTML='';

  if(files.length===0){
    tbody.innerHTML='<tr><td colspan="5" style="text-align:center;">Aucun fichier</td></tr>';
    downloadBtn.style.display="none";
    return;
  }

  downloadBtn.style.display="inline-block";

  for(const f of files){
    // Date
    let date='';
    const m=f.name.match(/(\d{8})\.csv$/i);
    if(m){ date=`${m[1].slice(0,4)}-${m[1].slice(4,6)}-${m[1].slice(6,8)}`; }
    else if(/\.(jpg|jpeg)$/i.test(f.name)){
      if(f.modifiedTime) date=f.modifiedTime.slice(0,10);
      else if(f.createdTime) date=f.createdTime.slice(0,10);
    }

    if((filterStartDate && date<filterStartDate) || (filterEndDate && date>filterEndDate)) continue;

const tr=document.createElement('tr');

    const tdFlame = document.createElement('td');
tdFlame.style.textAlign = "center";
tdFlame.style.width = "26px";
tdFlame.textContent = "";

    

    // üî• Application flamme si le fichier correspond √† un jour chaud
const match = f.name.match(/(\d{8})\.csv$/i);
if (match) {
  const dateKey = match[1];

  // üî• flamme si d√©j√† d√©tect√©e dans le cache
  if (hotDaysMap[dateKey]) {
    tdFlame.innerHTML = `<span class="flame" title="Br√ªleur actif ce jour-l√†">üî•</span>`;
  } else {
    // üïì attente de la fin du scan ‚Üí on v√©rifie √† nouveau apr√®s 1 seconde
    setTimeout(() => {
      if (hotDaysMap[dateKey]) {
        tdFlame.innerHTML = `<span class="flame" title="Br√ªleur actif ce jour-l√†">üî•</span>`;
      }
    }, 1000);
  }
}




// Bloc DATE avec affichage du jour
const tdDate=document.createElement('td');
if (date) {
  const d = new Date(date);
  const jours = ["Dimanche","Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi"];
  const jourNom = jours[d.getDay()];
  tdDate.textContent = `${date} (${jourNom})`;

  // Week-end ‚Üí rouge + gras
  if (d.getDay() === 0 || d.getDay() === 6) {
    tdDate.style.color = "var(--danger)";
    tdDate.style.fontWeight = "bold";
  }
} else {
  tdDate.textContent = '';
}

const tdName = document.createElement('td');
tdName.textContent = f.name;

// === FLAMME FILE (avec cancelScan) ===
if (f.name.toLowerCase().endsWith(".csv") &&
    (folderName.toLowerCase().includes("tra√ßa_temp") || folderName.toLowerCase().includes("traca_temp"))) {
  
  // Message provisoire
  tdName.innerHTML = `${f.name}&nbsp;&nbsp;&nbsp;<span style="color:gray;font-size:11px;">(scan en cours...)</span>`;

  (async () => {
    try {
      if (cancelScan) { tdName.innerHTML = f.name; return; } // üõë stop si demand√©

      const url = `https://smes21540.netlify.app/.netlify/functions/drive?id=${f.id}&name=${encodeURIComponent(f.name)}&site=Smes_Acces`;

      const res = await fetch(url);
      if (!res.ok) { tdName.innerHTML = f.name; return; }

      const text = await res.text();
      if (cancelScan) { tdName.innerHTML = f.name; return; } // üõë stop si demand√©

      const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");
      if (lines.length < 2) { tdName.innerHTML = f.name; return; }

      const headers = lines[0].split(",").map(h => h.replace(/"/g,"").trim().toLowerCase());
      let idxInf = headers.map((h,i)=>({h,i})).filter(o=>o.h.includes("sonde ac inf"))[1]?.i;
      let idxSup = headers.map((h,i)=>({h,i})).filter(o=>o.h.includes("sonde ac sup"))[1]?.i;

      if (idxInf === undefined && idxSup === undefined) { tdName.innerHTML = f.name; return; }

      let countFlame = 0;
for (let i = 1; i < lines.length; i++) {
  const cols = lines[i].split(",").map(c => c.replace(/"/g,"").trim());

  // üïî V√©rifie l‚Äôheure (colonne 0 suppos√©e √™tre l‚Äôheure du point)
  const timeStr = cols[0];
  if (timeStr && /^(\d{2}):(\d{2})/.test(timeStr)) {
    const [_, hh, mm] = timeStr.match(/^(\d{2}):(\d{2})/);
    const hour = parseInt(hh, 10);

    // ‚è∞ Ignore les valeurs avant 5h ou apr√®s 23h59
    if (hour < 5 || hour >= 24) continue;
  }

  const vInf = idxInf !== undefined ? parseFloat(cols[idxInf]) : NaN;
  const vSup = idxSup !== undefined ? parseFloat(cols[idxSup]) : NaN;

  if ((isFinite(vInf) && vInf > FLAME_THRESHOLD) ||
      (isFinite(vSup) && vSup > FLAME_THRESHOLD)) {
    countFlame++;
  }
}


if (countFlame >= 1) {
  tdFlame.innerHTML = `<span class="flame" title="Br√ªleur actif d√©tect√© ce jour !">üî•</span>`;
}
tdName.textContent = f.name;

    } catch(e) {
      console.error("Erreur flamme fichier:", f.name, e);
      tdName.innerHTML = f.name;
    }
  })();
}
// === FIN FLAMME FILE ===



const tdFolder=document.createElement('td'); tdFolder.textContent=folderName;

    const tdSize = document.createElement('td');
    if (f.size) {
      tdSize.textContent = formatSize(f.size);
      if (parseInt(f.size) < 200) {
        tdSize.style.color = "#999";
        tdSize.textContent += " (vide)";
      } else {
        tdSize.style.color = "inherit";
      }
    } else {
      tdSize.textContent = '?';
    }

    const tdAction=document.createElement('td'); tdAction.className='action-cell';
    let html='';
if(f.name.toLowerCase().endsWith('.csv')){
  html+=`<a href="https://drive.google.com/uc?export=download&id=${f.id}" target="_blank"><button class="action-btn">T√©l√©charger</button></a>`;
  html+=`<button class="action-btn" onclick="openViewer('viewer.html','${f.id}','${f.name}')">Tableau</button>`;

  // üëá bouton Courbes seulement si on n'est PAS dans Historique
  if (!folderName.toLowerCase().includes("historique")) {
    html+=`<button class="action-btn" onclick="openViewer('viewer02.html','${f.id}','${f.name}')">Courbes</button>`;
  }

  // üëá bouton Sondes uniquement si on est dans Tra√ßa_Temp
  if (folderName.toLowerCase().includes("tra√ßa_temp") || folderName.toLowerCase().includes("traca_temp")) {
    html+=`<button class="action-btn" onclick="openViewer('index03.html','${f.id}','${f.name}')">Sondes</button>`;
  }
}



    if(/\.(jpg|jpeg)$/i.test(f.name)){
      html+=`<img src="https://drive.google.com/thumbnail?id=${f.id}" onclick="openModal('${f.id}')" alt="aper√ßu">`;
      html+=`<a href="https://drive.google.com/uc?export=download&id=${f.id}" target="_blank"><button class="action-btn">T√©l√©charger</button></a>`;
    }
    tdAction.innerHTML=html;


tr.appendChild(tdDate);
    tr.appendChild(tdFlame);
tr.appendChild(tdAction);
tr.appendChild(tdName);
tr.appendChild(tdFolder);
tr.appendChild(tdSize);


    tbody.appendChild(tr);
  }
}
}

/* ----------- Open viewer (CSV list + index) ----------- */
async function openViewer(viewer, id, name){
  cancelScan = true; // üõë stoppe imm√©diatement tous les scans

  const active = document.querySelector('#folderTree .active-folder');
  if (!active) { alert("S√©lectionnez un dossier !"); return; }

  const folderId = localStorage.getItem('lastFolderId');

  // üìÇ Charger tous les fichiers du dossier courant
  const files = await fetchFolderContents(folderId);

  // üß© S√©parer les fichiers CSV et JSON
  const saFiles = files.filter(f =>
    f.name.toUpperCase().startsWith("SA") &&
    f.name.toLowerCase().endsWith(".csv")
  );
  const jsonFiles = files.filter(f =>
    f.name.toLowerCase().endsWith(".json")
  );

  // üîó R√©cup√©rer les Z3 pr√©charg√©s
  const z3Files = JSON.parse(localStorage.getItem("csvZ3Files") || "[]");

  // üóíÔ∏è Ajouter les fichiers .json dans le cache
  if (jsonFiles.length > 0) {
    console.log(`[Notes] ${jsonFiles.length} fichiers .json ajout√©s au cache`);
    jsonFiles.forEach(jf => {
      if (!jf.parents) jf.parents = [folderId];
      if (!jf.mimeType) jf.mimeType = "application/json";
    });
  }

  // üß† Fusionner le tout
  const allCsv = [...saFiles, ...z3Files, ...jsonFiles];

  function addFolderHierarchy(li, acc){
    if (!li) return;
    const nameSpan = li.querySelector('.folder-name');
    const folderObj = { id: li.dataset.id, name: nameSpan ? nameSpan.textContent : '', parents: [] };
    const parentLi = li.parentElement.closest('li');
    if (parentLi) {
      folderObj.parents.push(parentLi.dataset.id);
      addFolderHierarchy(parentLi, acc);
    }
    if (!acc.find(x => x.id === folderObj.id)) {
      acc.push(folderObj);
    }
  }

  const activeLi = active.closest('li');
  addFolderHierarchy(activeLi, allCsv);
  allCsv.forEach(f => {
    if (!f.parents) f.parents = [];
    if (!f.parents.includes(activeLi.dataset.id)) {
      f.parents.push(activeLi.dataset.id);
    }
  });

  localStorage.setItem("csvFilesList", JSON.stringify(allCsv));
  const index = allCsv.findIndex(f => f.id === id);
  localStorage.setItem("csvFileIndex", index);

  // üîç V√©rifier plan_sondes.csv
  const planFile = files.find(f => f.name.toLowerCase() === "plan_sondes.csv");
  let url = `${viewer}?fileId=${id}&fileName=${encodeURIComponent(name)}`;

const folderPath = localStorage.getItem("lastFolderPath") || "";
url += `&folderPath=${encodeURIComponent(folderPath)}`;
console.log("[Viewer] Dossier ajout√© √† l‚ÄôURL :", folderPath);
  // üîπ Sauvegarde explicite du chemin pour le viewer02
localStorage.setItem("currentFolderPath", folderPath);


  
  if (planFile) {
    try {
      const respPlan = await fetch(`https://smes21540.netlify.app/.netlify/functions/drive?id=${planFile.id}&name=${encodeURIComponent(planFile.name)}&site=Smes_Acces`);
      const textPlan = await respPlan.text();
      localStorage.setItem("planSondes", textPlan);
    } catch (e) {
      console.error("‚ùå Erreur lors du chargement du plan_sondes.csv", e);
    }
  } else {
    localStorage.removeItem("planSondes");
  }




  window.open(url,'_blank');
  setTimeout(() => { cancelScan = false; }, 1000);
}




/* ----------- Filtres ----------- */
function applyFilter(){
  filterStartDate=document.getElementById('startDate').value;
  filterEndDate=document.getElementById('endDate').value;
  const active=document.querySelector('#folderTree .active-folder');
  if(active) active.click();
}
function clearFilter(){
  filterStartDate=''; filterEndDate='';
  document.getElementById('startDate').value=''; document.getElementById('endDate').value='';
  const active=document.querySelector('#folderTree .active-folder');
  if(active) active.click();
}

/* ----------- Modale images + navigation clavier ----------- */
function openModal(id){
  const modal=document.getElementById('imageModal');
  modal.style.display='block';
  document.getElementById('modalFrame').src=`https://drive.google.com/file/d/${id}/preview`;
  currentImageIndex=imageFiles.findIndex(f=>f.id===id);
  document.getElementById('downloadBtn').onclick=()=>window.open(`https://drive.google.com/uc?export=download&id=${id}`,'_blank');
}
function closeModal(){document.getElementById('imageModal').style.display='none';}

document.getElementById('prevBtn').onclick=()=>{if(currentImageIndex>0) openModal(imageFiles[--currentImageIndex].id);};
document.getElementById('nextBtn').onclick=()=>{if(currentImageIndex<imageFiles.length-1) openModal(imageFiles[++currentImageIndex].id);};
window.addEventListener('click',e=>{if(e.target===document.getElementById('imageModal')) closeModal();});

// Navigation clavier quand la modale est ouverte
window.addEventListener('keydown', e=>{
  const modal=document.getElementById('imageModal');
  if(modal.style.display==='block'){
    if(e.key==='ArrowLeft' && currentImageIndex>0){ openModal(imageFiles[--currentImageIndex].id); }
    if(e.key==='ArrowRight' && currentImageIndex<imageFiles.length-1){ openModal(imageFiles[++currentImageIndex].id); }
    if(e.key==='Escape'){ closeModal(); }
  }
});

/* ----------- ZIP overlay + progression + annulation ----------- */
const zipOverlay=document.getElementById('zipOverlay');
const zipProgress=document.getElementById('zipProgress');
const zipCounter=document.getElementById('zipCounter');
const zipFileName=document.getElementById('zipFileName');
const zipTime=document.getElementById('zipTime');
const zipClose=document.getElementById('zipClose');
let zipCancelled=false, zipStartTime=0;

function sanitizeFileName(name){ return name.replace(/[\/\:*?"<>|]/g,"_"); }

function showZipOverlay(name){
  zipCancelled=false;
  zipOverlay.style.display='flex';
  zipFileName.textContent=name;
  zipProgress.style.width='0%';
  zipProgress.textContent='0%';
  zipCounter.textContent='0 / 0 fichiers';
  zipTime.textContent='Temps restant : --';
  zipStartTime=Date.now();
}
function hideZipOverlay(){zipOverlay.style.display='none';}
function updateZipProgress(pct,current,total,sizeAccum){
  zipProgress.style.width=pct+'%';
  zipProgress.textContent=pct+'%';
  zipCounter.textContent=`${current} / ${total} fichiers`;
  if(current>0){
    const elapsed=(Date.now()-zipStartTime)/1000;
    const speedFiles=current/elapsed;
    const speedKB=(sizeAccum/1024)/elapsed;
    const remainingFiles=total-current;
    const remainingTime=remainingFiles/Math.max(speedFiles,0.0001);
    const mins=Math.floor(remainingTime/60);
    const secs=Math.round(remainingTime%60);
    zipTime.textContent=`Temps restant : ${mins>0?mins+'m ':''}${secs}s (${speedFiles.toFixed(1)} fichiers/s, ${Math.max(0,speedKB).toFixed(0)} Ko/s)`;
  }
}
zipClose.onclick=()=>{zipCancelled=true;hideZipOverlay();alert("Pr√©paration ZIP annul√©e.");};

document.getElementById('downloadFolderBtn').onclick=async()=>{
  const active=document.querySelector('#folderTree .active-folder');
  if(!active){alert("S√©lectionnez un dossier !"); return;}
  const folderId=localStorage.getItem('lastFolderId');
  const folderName=active.textContent.trim();
  showZipOverlay(folderName+".zip");
  const files=await fetchFolderContents(folderId);
  if(!files||files.length===0){hideZipOverlay();alert("Aucun fichier dans ce dossier."); return;}
  const zip=new JSZip(); let count=0; let doneSize=0;
  for(const f of files){
    if(zipCancelled) return;
    try{
const url = `https://smes21540.netlify.app/.netlify/functions/drive?id=${f.id}&name=${encodeURIComponent(f.name)}&site=Smes_Acces`;

const res = await fetch(url);

      if(!res.ok) throw new Error('Fetch media failed: '+res.status);
      const blob=await res.blob();
      zip.file(sanitizeFileName(f.name), blob);
      count++; doneSize += f.size ? parseInt(f.size) : 0;
      updateZipProgress(Math.round((count/files.length)*100), count, files.length, doneSize);
    }catch(e){console.error("Erreur sur",f.name,e);}
  }
  if(zipCancelled) return;
  const content=await zip.generateAsync({type:"blob"});
  saveAs(content, folderName+".zip");
  hideZipOverlay();
};

/* ----------- Tri tableau + recolorisation ----------- */
let currentSort = { col: null, asc: true };

function sortTable(colIndex, type) {
  const table = document.getElementById("csvTable");
  const tbody = table.tBodies[0];
  const rows = Array.from(tbody.querySelectorAll("tr"));

  if (currentSort.col === colIndex) {
    currentSort.asc = !currentSort.asc;
  } else {
    currentSort.col = colIndex;
    currentSort.asc = true;
  }

  rows.sort((a, b) => {
    let aText = a.cells[colIndex]?.textContent.trim() || "";
    let bText = b.cells[colIndex]?.textContent.trim() || "";
    if (type === "number") {
      aText = parseFloat(aText) || 0;
      bText = parseFloat(bText) || 0;
    } else if (type === "date") {
      aText = new Date(aText).getTime() || 0;
      bText = new Date(bText).getTime() || 0;
    }
    if (aText < bText) return currentSort.asc ? -1 : 1;
    if (aText > bText) return currentSort.asc ? 1 : -1;
    return 0;
  });

  tbody.innerHTML = "";
  rows.forEach(r => tbody.appendChild(r));

  // mise √† jour des fl√®ches
  document.querySelectorAll("thead th .sort-arrow").forEach(span => span.textContent = "");
  const arrow = table.tHead.rows[0].cells[colIndex].querySelector(".sort-arrow");
  if (arrow) arrow.textContent = currentSort.asc ? "‚ñ≤" : "‚ñº";
}

/* ----------- Ic√¥nes calendrier cliquables ----------- */
document.getElementById("iconStart").onclick=()=>document.getElementById("startDate").showPicker?.()||document.getElementById("startDate").focus();
document.getElementById("iconEnd").onclick=()=>document.getElementById("endDate").showPicker?.()||document.getElementById("endDate").focus();

/* ----------- Menu secret (th√®mes) ----------- */
document.getElementById("secretBtn").onclick=()=>{
  const menu=document.getElementById("themeMenu");
  if(menu.style.display==="block"){ closeThemeMenu(); }
  else { menu.style.display="block"; resetThemeMenuTimer(); }
};
function resetThemeMenuTimer(){ clearTimeout(themeMenuTimer); themeMenuTimer=setTimeout(closeThemeMenu,10000); }
function closeThemeMenu(){ document.getElementById("themeMenu").style.display="none"; clearTimeout(themeMenuTimer); }

/* ----------- Th√®mes + persistance (+ lignes du tableau) ----------- */
function setTheme(theme){
  const r=document.documentElement;
  const logo=document.getElementById("mainLogo");
  logo.style.display=(theme==="orange")?"block":"none";
  localStorage.setItem("selectedTheme",theme);

  if(theme==="orange"){
    r.style.setProperty("--accent","#ff7043");
    r.style.setProperty("--accent-darker","#e64a19");
    r.style.setProperty("--accent-muted","#ffccbc");
    r.style.setProperty("--bg","#fff5f5");
    r.style.setProperty("--panel","#ffffff");
    r.style.setProperty("--sidebar-bg","#ffe5d9");
    r.style.setProperty("--danger","#d84315");
    r.style.setProperty("--text","#333");
    r.style.setProperty("--row-even","#ffe5d9");
    r.style.setProperty("--row-odd","#fff5f5");
  }
  if(theme==="blue"){
    r.style.setProperty("--accent","#2196f3");
    r.style.setProperty("--accent-darker","#1976d2");
    r.style.setProperty("--accent-muted","#bbdefb");
    r.style.setProperty("--bg","#e3f2fd");
    r.style.setProperty("--panel","#ffffff");
    r.style.setProperty("--sidebar-bg","#bbdefb");
    r.style.setProperty("--danger","#0d47a1");
    r.style.setProperty("--text","#0d47a1");
    r.style.setProperty("--row-even","#bbdefb");
    r.style.setProperty("--row-odd","#e3f2fd");
  }
  if(theme==="green"){
    r.style.setProperty("--accent","#4caf50");
    r.style.setProperty("--accent-darker","#2e7d32");
    r.style.setProperty("--accent-muted","#c8e6c9");
    r.style.setProperty("--bg","#f1f8e9");
    r.style.setProperty("--panel","#ffffff");
    r.style.setProperty("--sidebar-bg","#c8e6c9");
    r.style.setProperty("--danger","#1b5e20");
    r.style.setProperty("--text","#1b5e20");
    r.style.setProperty("--row-even","#c8e6c9");
    r.style.setProperty("--row-odd","#f1f8e9");
  }
  if(theme==="purple"){
    r.style.setProperty("--accent","#9c27b0");
    r.style.setProperty("--accent-darker","#6a1b9a");
    r.style.setProperty("--accent-muted","#e1bee7");
    r.style.setProperty("--bg","#f3e5f5");
    r.style.setProperty("--panel","#ffffff");
    r.style.setProperty("--sidebar-bg","#e1bee7");
    r.style.setProperty("--danger","#4a148c");
    r.style.setProperty("--text","#4a148c");
    r.style.setProperty("--row-even","#e1bee7");
    r.style.setProperty("--row-odd","#f3e5f5");
  }
  if(theme==="bordeaux"){
    r.style.setProperty("--accent","#800020");
    r.style.setProperty("--accent-darker","#4b0014");
    r.style.setProperty("--accent-muted","#d7a1a9");
    r.style.setProperty("--bg","#fff0f2");
    r.style.setProperty("--panel","#ffffff");
    r.style.setProperty("--sidebar-bg","#f3cdd3");
    r.style.setProperty("--danger","#600018");
    r.style.setProperty("--text","#4b0014");
    r.style.setProperty("--row-even","#f3cdd3");
    r.style.setProperty("--row-odd","#fff0f2");
  }
}

/* ----------- üî• Gestion des jours chauds par site ----------- */
const FLAME_MIN_LINES = 5;
let currentSiteId = null;
let hotDaysMap = {}; // { 'YYYYMMDD': true }

async function scanSiteHotDays(siteId) {
  const hotDays = {};
  console.time(`[SCAN] Dur√©e scanSiteHotDays (${siteId})`);
  console.log(`[SCAN] Scan du site ${siteId} ‚Üí dossier Tra√ßa_Temp`);

  try {
    const siblings = await fetchFolderContents(siteId);
    const tracatemp = siblings.find(s => 
      s.mimeType === 'application/vnd.google-apps.folder' &&
      (s.name.toLowerCase().includes("tra√ßa_temp") || s.name.toLowerCase().includes("traca_temp"))
    );
    if (!tracatemp) {
      console.warn(`[SCAN] Aucun dossier Tra√ßa_Temp trouv√© pour le site ${siteId}`);
      return hotDays;
    }

    const files = await fetchFolderContents(tracatemp.id);
    const csvFiles = files.filter(f => f.name.toLowerCase().endsWith(".csv"));
    console.log(`[SCAN] ${csvFiles.length} CSV trouv√©s dans ${tracatemp.name}`);

    for (const f of csvFiles) {
      try {
        const res = await fetch(
          `https://smes21540.netlify.app/.netlify/functions/drive?id=${f.id}&name=${encodeURIComponent(f.name)}&site=Smes_Acces`
        );
        if (!res.ok) continue;

        const text = await res.text();
        const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");
        if (lines.length < 2) continue;

        const headers = lines[0].split(",").map(h => h.replace(/"/g, "").trim().toLowerCase());

        // üîç 2√®me occurrence (comme ton ancien index)
        let idxInf = headers.map((h,i)=>({h,i})).filter(o=>o.h.includes("sonde ac inf"))[1]?.i;
        let idxSup = headers.map((h,i)=>({h,i})).filter(o=>o.h.includes("sonde ac sup"))[1]?.i;
        if (idxInf === undefined && idxSup === undefined) continue;

        let countFlame = 0;
        for (let i = 1; i < lines.length; i++) {
          const cols = lines[i].split(",").map(c => c.replace(/"/g, "").trim());

          // üïî ignore la nuit (<5h)
          const timeStr = cols[0];
          if (timeStr && /^(\d{2}):(\d{2})/.test(timeStr)) {
            const [_, hh] = timeStr.match(/^(\d{2}):/);
            const hour = parseInt(hh, 10);
            if (hour < 5) continue;
          }

          const vInf = idxInf !== undefined ? parseFloat(cols[idxInf]) : NaN;
          const vSup = idxSup !== undefined ? parseFloat(cols[idxSup]) : NaN;

          if ((isFinite(vInf) && vInf > FLAME_THRESHOLD) ||
              (isFinite(vSup) && vSup > FLAME_THRESHOLD)) {
            countFlame++;
          }
        }

        if (countFlame >= 1) {
          const m = f.name.match(/(\d{8})\.csv$/i);
          if (m) hotDays[m[1]] = true;
        }

      } catch (e) {
        console.warn(`[SCAN] Erreur lecture fichier ${f.name}:`, e);
      }
    }

    console.log(`[SCAN] üî• ${Object.keys(hotDays).length} jours chauds d√©tect√©s pour le site`);
    console.timeEnd(`[SCAN] Dur√©e scanSiteHotDays (${siteId})`);
    localStorage.setItem(`hotDays_${siteId}`, JSON.stringify(hotDays));
    return hotDays;

  } catch (err) {
    console.error("[SCAN] Erreur g√©n√©rale scanSiteHotDays:", err);
    console.timeEnd(`[SCAN] Dur√©e scanSiteHotDays (${siteId})`);
    return hotDays;
  }
}


function loadSiteHotDays(siteId) {
  const data = localStorage.getItem(`hotDays_${siteId}`);
  return data ? JSON.parse(data) : {};
}


function clearSiteHotDays() {
  if (currentSiteId) {
    localStorage.removeItem(`hotDays_${currentSiteId}`);
  }
  hotDaysMap = {};
  currentSiteId = null;
}



  
/* ----------- üî• V√©rif CSV du jour pour "Temp" ----------- */
async function checkTra√ßaTempToday(parentLi, tracatempId) {
  const today = new Date();
  const yyyymmdd =
    today.getFullYear().toString() +
    String(today.getMonth() + 1).padStart(2, "0") +
    String(today.getDate()).padStart(2, "0");

  const files = await fetchFolderContents(tracatempId);
  // accepter tout CSV contenant la date du jour
  const todayFile = files.find(f => f.name.includes(yyyymmdd) && f.name.endsWith(".csv"));
  if (!todayFile) return;

  try {
const url = `https://smes21540.netlify.app/.netlify/functions/drive?id=${todayFile.id}&name=${encodeURIComponent(todayFile.name)}&t=${Date.now()}&site=Smes_Acces`;

const res = await fetch(url);

    const text = await res.text();

    // lire les derni√®res lignes
    const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");
    const lastLine = lines[lines.length - 1];
    if (!lastLine) return;

    // Nettoyage : enlever guillemets et espaces
    const headers = lines[0].split(",").map(h => h.replace(/"/g, "").trim());
    const cols = lastLine.split(",").map(c => c.replace(/"/g, "").trim());

    // Trouver la 2√®me occurrence de "Sonde AC Sup"
    let supIndices = headers
      .map((h, i) => ({ h, i }))
      .filter(o => o.h.toLowerCase().includes("sonde ac sup"));
    let idxSup = supIndices.length >= 2 ? supIndices[1].i : supIndices[0]?.i;

    // Trouver la 2√®me occurrence de "Sonde AC Inf"
    let infIndices = headers
      .map((h, i) => ({ h, i }))
      .filter(o => o.h.toLowerCase().includes("sonde ac inf"));
    let idxInf = infIndices.length >= 2 ? infIndices[1].i : infIndices[0]?.i;

    // Valeurs
    const vSup = idxSup !== undefined ? parseFloat(cols[idxSup]) : NaN;
    const vInf = idxInf !== undefined ? parseFloat(cols[idxInf]) : NaN;

    // üî• seuil
    if ((vSup && vSup > FLAME_THRESHOLD) || (vInf && vInf > FLAME_THRESHOLD)) {
      markFolderWithFlame(parentLi);
    }


  } catch (e) {
    console.error("Erreur lecture CSV dans Temp", e);
  }
}

function markFolderWithFlame(li) {
  if (!li) return; // s√©curit√©

  const span = li.querySelector(".folder-name");
  if (!(span instanceof HTMLElement)) return; // √©vite les erreurs de type

  if (!span.classList.contains("has-flame")) {
    span.classList.add("has-flame");
    span.innerHTML = `<span class="flame-folder" title="Br√ªleur(s) actuellement en fonctionnement">üî•</span> ` + span.innerHTML;
  }

  const parent = li.parentElement?.closest("li");
  if (parent) markFolderWithFlame(parent);
}





/* ----------- Init ----------- */
window.onload=()=>{
  updateNetworkStatus();
  const savedTheme=localStorage.getItem("selectedTheme")||"orange";
  setTheme(savedTheme);

  // bouton "T√©l√©charger le dossier" cach√© par d√©faut tant qu'aucun contenu
  document.getElementById("downloadFolderBtn").style.display="none";

  loadRootFolders();
const last = localStorage.getItem("lastFolderId");
if (last) {
  // attendre un peu que l'arborescence soit rendue
  setTimeout(() => {
    const li = document.querySelector(`#folderTree li[data-id="${last}"]`);
    if (li) {
      loadFolderFilesOnClick(li);
    } else {
      console.warn("[INIT] Impossible de retrouver le dernier dossier ouvert :", last);
    }
  }, 1200);
}

};
</script>
</body>
</html>








