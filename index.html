<!DOCTYPE html>
<html lang="fr">
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-YG4RV4W27S"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-YG4RV4W27S');
</script>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Explorateur donn√©es s√©choirs</title>

<!-- D√©pendances -->
<script src="libs/jszip.min.js"></script>
<script src="libs/FileSaver.min.js"></script>

<style>
:root{
  --bg:#fff5f5;
  --panel:#ffffff;
  --sidebar-bg:#ffe5d9;
  --text:#333;
  --muted-text:#555;
  --shadow:rgba(0,0,0,0.1);
  --overlay:rgba(0,0,0,0.8);
  --table-border:#eee;
  --thumb-border:#ccc;

  /* Th√®me (orange par d√©faut) */
  --accent:#ff7043;
  --accent-contrast:#fff;
  --accent-darker:#e64a19;
  --accent-muted:#ffccbc;
  --danger:#d84315;

  /* Couleurs des lignes du tableau */
  --row-even:#ffe5d9;
  --row-odd:#fff5f5;
}

*{box-sizing:border-box}

body{
  font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;
  background:var(--bg);color:var(--text);margin:0;padding:0;
  display:flex;height:100vh;overflow:hidden;
}

/* Alerte r√©seau */
#netAlert{
  display:none;position:fixed;top:0;left:0;right:0;z-index:3000;
  background:var(--accent-muted);color:var(--danger);
  padding:8px;text-align:center;font-weight:bold;
}

/* Sidebar */
#sidebar{
  background:var(--sidebar-bg);border-right:2px solid var(--accent);
  padding:20px 10px;overflow-y:auto;z-index:1000;
  width:auto;min-width:200px;max-width:500px;
}
#sidebar h2{
  color:var(--accent);font-size:18px;font-weight:bold;text-transform:uppercase;
  margin:0 0 12px 0;padding-left:5px;display:flex;align-items:center;gap:6px;
}
#folderTree ul{list-style:none;padding-left:20px;margin:0;}
#folderTree li{cursor:pointer;margin:5px 0;}
.folder-toggle{font-weight:bold;margin-right:5px;cursor:pointer;color:var(--accent);}
.folder-name{cursor:pointer;}
.active-folder{background:var(--accent-muted);border-radius:3px;padding:2px 4px;}

/* Main */
#main{flex:1;padding:10px 20px;display:flex;flex-direction:column;overflow:hidden;}
.header{display:flex;align-items:center;justify-content:center;position:relative;margin-bottom:15px;}
.header .logo{height:60px;width:auto;}
#fileNameContainer{position:absolute;right:0;top:0;text-align:right;}
#fileName,#lineCount{color:var(--danger);}
#fileName{font-size:20px;font-weight:bold;white-space:nowrap;max-width:250px;overflow:hidden;text-overflow:ellipsis;display:none;}
#lineCount{font-size:12px;display:none;}

/* Contr√¥les */
.controls{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:10px;align-items:center;}
.controls button{
  background:var(--accent);color:var(--accent-contrast);
  border:none;cursor:pointer;font-weight:bold;
  padding:6px 12px;border-radius:6px;font-size:13px;transition:0.3s;
}
.controls button:hover{background:var(--accent-darker);transform:scale(1.05);}

/* Champs date + ic√¥ne custom */
.date-field{
  display:flex;align-items:center;gap:6px;background:var(--panel);
  border:2px solid var(--table-border);border-radius:6px;padding:4px 8px;
}
.date-field span{font-size:16px;color:var(--accent);cursor:pointer;user-select:none;transition:0.2s;}
.date-field span:hover{transform:scale(1.2);}
.date-field input[type=date]{border:none;outline:none;background:transparent;font-size:14px;color:var(--text);padding:6px 2px;}
input[type="date"]::-webkit-calendar-picker-indicator{display:none;-webkit-appearance:none;}
.date-field input[type=date]:focus {box-shadow:0 0 6px var(--accent);border-color:var(--accent);color:var(--danger);}

/* Tableau */
#tableWrapper{flex:1;overflow:auto;}
#tableContainer{overflow:auto;border-radius:8px;box-shadow:0 4px 12px var(--shadow);background:var(--panel);}
table{border-collapse:separate;border-spacing:0;width:100%;font-size:13px;}
thead th,tbody td{padding:10px 12px;text-align:left;border-bottom:1px solid var(--table-border);white-space:nowrap;}
thead th{
  position:sticky;top:0;z-index:2;background:var(--accent);
  color:var(--accent-contrast);font-weight:bold;text-transform:uppercase;cursor:pointer;
}
tbody tr:nth-child(even){background:var(--row-even);}
tbody tr:nth-child(odd){background:var(--row-odd);}
tbody tr:hover{background:var(--accent-muted);}
.sort-arrow{margin-left:5px;font-size:11px;color:var(--accent-contrast);}

/* Cellule actions + boutons survol */
td.action-cell{display:flex;align-items:center;gap:8px;}
.action-btn{
  background:var(--accent);color:var(--accent-contrast);border:none;cursor:pointer;
  font-weight:bold;padding:6px 12px;border-radius:6px;font-size:12px;transition:0.2s;
  margin-right:6px;opacity:0;visibility:hidden;
}
tbody tr:hover .action-btn{opacity:1;visibility:visible;}
.action-btn:hover{background:var(--accent-darker);transform:scale(1.05);}

/* Miniatures JPG */
#csvTable td img{
  max-width:120px;
  cursor:pointer;border-radius:6px;border:1px solid var(--thumb-border);
  transition:transform 0.2s,box-shadow 0.2s;margin-right:6px;
}
#csvTable td img:hover{transform:scale(1.08);box-shadow:0 0 8px var(--shadow);}

/* Fl√®che anim√©e */
@keyframes bounceLeft {0%,100% { transform: translateX(0);}50% { transform: translateX(-8px);} }
.arrow-hint {display:inline-block;margin-right:8px;color:var(--accent-darker);
  font-size:22px;animation:bounceLeft 1s infinite;}

/* Spinner */
#spinner{
  display:none;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  width:40px;height:40px;border:6px solid #f3f3f3;border-top:6px solid var(--accent);border-radius:50%;
}

/* Modale images */
.modal{display:none;position:fixed;z-index:1300;padding-top:50px;left:0;top:0;width:100%;height:100%;background-color:var(--overlay);text-align:center;}
.modal .close{position:absolute;top:15px;right:25px;color:#fff;font-size:30px;cursor:pointer;}
.modal iframe{width:90%;height:80vh;border:none;border-radius:10px;background:#000;}
.modal-actions{margin-top:15px;display:flex;justify-content:center;gap:10px;}
.modal-actions button{background:var(--accent);color:#fff;border:none;padding:8px 16px;border-radius:5px;cursor:pointer;font-weight:bold;}
.modal-actions button:hover{background:var(--accent-darker);}

/* Overlay ZIP */
#zipOverlay{
  display:none;position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.4);z-index:1400;justify-content:center;align-items:center;
}
#zipBox{
  background:var(--accent-muted);color:var(--text);padding:20px 25px;border-radius:12px;
  text-align:center;width:300px;box-shadow:0 4px 12px rgba(0,0,0,0.3);position:relative;
}
#zipBox h2{margin:0 0 10px 0;color:var(--accent);font-size:18px;}
#zipFileName{font-size:13px;margin-bottom:15px;color:var(--muted-text);word-break:break-word;}
#zipProgressBar{width:100%;height:22px;background:#eee;border-radius:11px;overflow:hidden;}
#zipProgress{
  height:100%;width:0;background:var(--accent);transition:width 0.3s;
  display:flex;align-items:center;justify-content:center;color:#fff;font-weight:bold;font-size:13px;
}
#zipCounter{margin-top:10px;font-size:12px;color:var(--text);}
#zipTime{margin-top:5px;font-size:12px;color:var(--muted-text);}
#zipClose{
  position:absolute;top:8px;right:12px;font-size:18px;font-weight:bold;color:var(--accent);cursor:pointer;
}
#zipClose:hover{color:var(--accent-darker);}

/* Menu secret (th√®mes) */
#secretBtn {
  position: fixed;bottom: 10px;right: 10px;width: 25px;height: 25px;
  opacity: 0;cursor: pointer;z-index: 2000;
}
#themeMenu {
  display:none;position:fixed;bottom:50px;right:10px;background: var(--panel);
  border:2px solid var(--accent);border-radius:8px;box-shadow:0 4px 12px var(--shadow);
  padding:10px;z-index:2001;min-width:150px;
}
#themeMenu h3 {margin:0 0 8px 0;font-size:14px;color: var(--accent);}
#themeMenu .closeMenu {position:absolute;top:5px;right:8px;font-size:14px;cursor:pointer;color:var(--accent);}
#themeMenu .closeMenu:hover {color:var(--accent-darker);}
#themeMenu button {
  display:block;width:100%;margin:4px 0;padding:6px;border:none;border-radius:6px;
  background: var(--accent);color: var(--accent-contrast);cursor:pointer;font-size:13px;
}
#themeMenu button:hover {background: var(--accent-darker);}
.flame {
  display:inline-block;
  animation:flicker 0.6s infinite alternate;
}

@keyframes flicker {
  from { transform: translateY(0); }
  to   { transform: translateY(-2px); }
}

</style>
</head>
<body>

<div id="netAlert">‚ö†Ô∏è Pas de connexion internet d√©tect√©e. V√©rifiez votre r√©seau.</div>
<div id="spinner"></div>

<!-- Sidebar dossiers -->
<div id="sidebar">
  <h2><span>üìÅ</span>Dossiers</h2>
  <ul id="folderTree"></ul>
</div>

<!-- Main -->
<div id="main">
  <div class="header">
    <img src="img/logo.png" class="logo" id="mainLogo" alt="Logo"/>
    <div id="fileNameContainer">
      <div id="fileName"></div>
      <div id="lineCount"></div>
    </div>
  </div>

  <div class="controls">
    Filtrer par date : 
    <div class="date-field"><span id="iconStart">üìÖ</span><input type="date" id="startDate"></div>
    √†
    <div class="date-field"><span id="iconEnd">üìÖ</span><input type="date" id="endDate"></div>
    <button onclick="applyFilter()">Filtrer</button>
    <button onclick="clearFilter()">Tout afficher</button>
    <button id="downloadFolderBtn">T√©l√©charger le dossier</button>
  </div>

  <div id="tableWrapper">
    <div id="tableContainer">
      <table id="csvTable">
        <thead>
          <tr>
            <th onclick="sortTable(0,'date')">Date <span class="sort-arrow"></span></th>
            <th>Nom du fichier</th>
            <th>Dossier</th>
            <th onclick="sortTable(3,'number')">Taille <span class="sort-arrow"></span></th>
            <th>T√©l√©charger / Ouvrir</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td colspan="5" style="text-align:left;">
              <span class="arrow-hint">‚¨Ö</span> S√©lectionner un dossier...
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modale image -->
<div id="imageModal" class="modal" role="dialog" aria-modal="true">
  <span class="close" onclick="closeModal()" aria-label="Fermer">&times;</span>
  <!-- tabindex=-1 pour √©viter que l'iframe vole le focus / bloque les fl√®ches -->
  <iframe id="modalFrame" tabindex="-1"></iframe>
  <div class="modal-actions">
    <button id="prevBtn">&larr; Pr√©c√©dent</button>
    <button id="nextBtn">Suivant &rarr;</button>
    <button id="downloadBtn">T√©l√©charger</button>
  </div>
</div>

<!-- Overlay ZIP -->
<div id="zipOverlay">
  <div id="zipBox">
    <span id="zipClose">&times;</span>
    <h2>Pr√©paration du ZIP...</h2>
    <div id="zipFileName"></div>
    <div id="zipProgressBar"><div id="zipProgress">0%</div></div>
    <div id="zipCounter">0 / 0 fichiers</div>
    <div id="zipTime">Temps restant : --</div>
  </div>
</div>

<!-- Bouton secret + menu th√®mes -->
<div id="secretBtn" title=" "></div>
<div id="themeMenu">
  <span class="closeMenu" onclick="closeThemeMenu()">‚ùå</span>
  <h3>Choisir un th√®me</h3>
  <button onclick="setTheme('orange')">Orange (d√©faut)</button>
  <button onclick="setTheme('blue')">Bleu</button>
  <button onclick="setTheme('green')">Vert</button>
  <button onclick="setTheme('purple')">Violet</button>
  <button onclick="setTheme('bordeaux')">Bordeaux</button>
</div>

<script>
/* ----------- Config Drive ----------- */
const API_KEY="AIzaSyCbEV3CS9bOcxq5eK-QXbjczGHjvzyXS6M";
const ROOT_FOLDER_ID="18QkQPyCZxTCAaoz_qd1wAelmQbSE4ex8";

/* ----------- Config personnalis√©e ----------- */
const FLAME_THRESHOLD = 40.0;   // seuil d√©clencheur de la flamme üî•

/* ----------- √âtat ----------- */
let imageFiles=[], currentImageIndex=0;
let filterStartDate="", filterEndDate="";
let themeMenuTimer;

/* ----------- Utilitaires UI ----------- */
const spinner=document.getElementById('spinner');
function showSpinner(){spinner.style.display='block';}
function hideSpinner(){spinner.style.display='none';}

function updateNetworkStatus(){
  document.getElementById("netAlert").style.display = navigator.onLine ? "none" : "block";
}
window.addEventListener("online",updateNetworkStatus);
window.addEventListener("offline",updateNetworkStatus);

function formatSize(bytes){
  if(!bytes) return "?";
  const units=["o","Ko","Mo","Go"]; let i=0; let v=Number(bytes);
  while(v>=1024 && i<units.length-1){ v/=1024; i++; }
  return (i===0?Math.round(v):v.toFixed(1))+" "+units[i];
}

/* ----------- Drive API ----------- */
async function fetchFolderContents(folderId){
  if(!navigator.onLine){updateNetworkStatus();return [];}
  showSpinner();
  try{
    const res=await fetch(`https://www.googleapis.com/drive/v3/files?q='${folderId}'+in+parents+and+trashed=false&key=${API_KEY}&fields=files(id,name,mimeType,size,createdTime,modifiedTime)`);
    const data=await res.json();
    if(data.error){
      alert("Erreur Drive: "+data.error.message);
      console.error("Drive error:", data.error);
      return [];
    }
    return data.files||[];
  }catch(e){
    console.error("Erreur Drive:",e);
    alert("Impossible de charger le dossier (r√©seau/API). Ouvre la console pour le d√©tail.");
    return [];
  }finally{hideSpinner();}
}

async function loadRootFolders(){
  const files = await fetchFolderContents(ROOT_FOLDER_ID);
  const rootUL = document.getElementById('folderTree');
  rootUL.innerHTML = '';

  files.filter(f => f.mimeType === 'application/vnd.google-apps.folder').forEach(f => {
    const li = document.createElement('li'); 
    li.dataset.id = f.id;

    const toggle = document.createElement('span'); 
    toggle.className = 'folder-toggle'; 
    toggle.textContent = '+';
    toggle.onclick = () => toggleFolder(li);

    const span = document.createElement('span'); 
    span.className = 'folder-name'; 
    span.textContent = f.name;
    span.onclick = () => loadFolderFilesOnClick(li);

    li.appendChild(toggle); 
    li.appendChild(span); 
    rootUL.appendChild(li);
  });

  // üî• V√©rifier automatiquement deux crans plus bas sans ouvrir visuellement
  setTimeout(async () => {
    const siteFolders = document.querySelectorAll("#folderTree > li");

    for (const siteLi of siteFolders) {
      const subFolders = await fetchChildren(siteLi.dataset.id);
      for (const sub of subFolders) {
        if (sub.name.includes("Temp")) {
          await checkTra√ßaTempToday(siteLi, sub.id); 
        }
      }
    }
  }, 1000);
}

async function toggleFolder(li){
  const toggle=li.querySelector('.folder-toggle');
  if(li.dataset.loaded==='true'){
    const ul=li.querySelector('ul');
    if(ul){ul.style.display=ul.style.display==='none'?'block':'none'; toggle.textContent=ul.style.display==='block'?'‚Äì':'+';}
    return;
  }
  toggle.textContent='‚Ä¶';
  const files=await fetchFolderContents(li.dataset.id);
  const ul=document.createElement('ul');
  for (const f of files.filter(f => f.mimeType === 'application/vnd.google-apps.folder')) {
    const childLi=document.createElement('li'); 
    childLi.dataset.id=f.id;

    const childToggle=document.createElement('span'); 
    childToggle.className='folder-toggle'; 
    childToggle.textContent='+';
    childToggle.onclick=()=>toggleFolder(childLi);

    const span=document.createElement('span'); 
    span.className='folder-name'; 
    span.textContent=f.name;
    span.onclick=()=>loadFolderFilesOnClick(childLi);

    childLi.appendChild(childToggle); 
    childLi.appendChild(span); 
    ul.appendChild(childLi);

    // ‚úÖ Cas sp√©cial : si le dossier est Tra√ßa_Temp ‚Üí pr√©charger Historique
    if (f.name.toLowerCase().includes("tra√ßa_temp") || f.name.toLowerCase().includes("traca_temp")) {
      const siblings = await fetchFolderContents(li.dataset.id);
      const hist = siblings.find(s => s.mimeType === 'application/vnd.google-apps.folder' && s.name.toLowerCase().includes("historique"));
      if (hist) {
        const histFiles = await fetchFolderContents(hist.id);
        const z3Files = histFiles.filter(ff => ff.name.toUpperCase().startsWith("Z3") && ff.name.toLowerCase().endsWith(".csv"));
        localStorage.setItem("csvZ3Files", JSON.stringify(z3Files));
        console.log("[INDEX] Z3 pr√©charg√©s:", z3Files.length);
      }
    }

    // ‚úÖ V√©rif Temp (flamme üî•)
    if(f.name.includes("Temp")){ checkTra√ßaTempToday(li, f.id); }
  }
  li.appendChild(ul); 
  li.dataset.loaded='true'; 
  toggle.textContent='+';
}


// Fonction utilitaire pour r√©cup√©rer les sous-dossiers sans modifier l'affichage
async function fetchChildren(folderId){
  const files = await fetchFolderContents(folderId);
  return files.filter(f => f.mimeType === 'application/vnd.google-apps.folder');
}

async function loadFolderFilesOnClick(li){
  await toggleFolder(li);
  document.querySelectorAll('#folderTree li span.folder-name').forEach(s=>s.classList.remove('active-folder'));
  const nameSpan=li.querySelector('span.folder-name');
  if(nameSpan){ nameSpan.classList.add('active-folder'); }
  localStorage.setItem('lastFolderId', li.dataset.id);

  const files = await fetchFolderContents(li.dataset.id);
  const filtered = files.filter(f => f.name.toLowerCase().endsWith('.csv') || f.name.toLowerCase().endsWith('.jpg') || f.name.toLowerCase().endsWith('.jpeg'));
  imageFiles = filtered.filter(f => /\.(jpg|jpeg)$/i.test(f.name)); // pour la modale
  displayFiles(filtered, nameSpan ? nameSpan.textContent : '');
}

function displayFiles(files, folderName){
  const tbody=document.querySelector('#csvTable tbody');
  const downloadBtn=document.getElementById('downloadFolderBtn');
  tbody.innerHTML='';

  if(files.length===0){
    tbody.innerHTML='<tr><td colspan="5" style="text-align:center;">Aucun fichier</td></tr>';
    downloadBtn.style.display="none";
    return;
  }

  downloadBtn.style.display="inline-block";

  for(const f of files){
    // Date
    let date='';
    const m=f.name.match(/(\d{8})\.csv$/i);
    if(m){ date=`${m[1].slice(0,4)}-${m[1].slice(4,6)}-${m[1].slice(6,8)}`; }
    else if(/\.(jpg|jpeg)$/i.test(f.name)){
      if(f.modifiedTime) date=f.modifiedTime.slice(0,10);
      else if(f.createdTime) date=f.createdTime.slice(0,10);
    }

    if((filterStartDate && date<filterStartDate) || (filterEndDate && date>filterEndDate)) continue;

    const tr=document.createElement('tr');
    const tdDate=document.createElement('td'); tdDate.textContent=date||'';
    const tdName=document.createElement('td'); tdName.textContent=f.name;
    const tdFolder=document.createElement('td'); tdFolder.textContent=folderName;
    const tdSize = document.createElement('td');
    if (f.size) {
      tdSize.textContent = formatSize(f.size);
      if (parseInt(f.size) < 200) {
        tdSize.style.color = "#999";
        tdSize.textContent += " (vide)";
      } else {
        tdSize.style.color = "inherit";
      }
    } else {
      tdSize.textContent = '?';
    }

    const tdAction=document.createElement('td'); tdAction.className='action-cell';
    let html='';
    if(f.name.toLowerCase().endsWith('.csv')){
      html+=`<a href="https://drive.google.com/uc?export=download&id=${f.id}" target="_blank"><button class="action-btn">T√©l√©charger</button></a>`;
      html+=`<button class="action-btn" onclick="openViewer('viewer.html','${f.id}','${f.name}')">Tableau</button>`;
      html+=`<button class="action-btn" onclick="openViewer('viewer02.html','${f.id}','${f.name}')">Courbes</button>`;
    }
    if(/\.(jpg|jpeg)$/i.test(f.name)){
      html+=`<img src="https://drive.google.com/thumbnail?id=${f.id}" onclick="openModal('${f.id}')" alt="aper√ßu">`;
      html+=`<a href="https://drive.google.com/uc?export=download&id=${f.id}" target="_blank"><button class="action-btn">T√©l√©charger</button></a>`;
    }
    tdAction.innerHTML=html;

    tr.appendChild(tdDate); tr.appendChild(tdName); tr.appendChild(tdFolder); tr.appendChild(tdSize); tr.appendChild(tdAction);
    tbody.appendChild(tr);
  }
}

/* ----------- Open viewer (CSV list + index) ----------- */
async function openViewer(viewer, id, name){
  const active = document.querySelector('#folderTree .active-folder');
  if (!active) { alert("S√©lectionnez un dossier !"); return; }

  const folderId = localStorage.getItem('lastFolderId');

  // SA du dossier courant
  const files = await fetchFolderContents(folderId);
  const saFiles = files.filter(f => f.name.toUpperCase().startsWith("SA") && f.name.toLowerCase().endsWith('.csv'));

  // üîó R√©cup√©rer les Z3 pr√©charg√©s
  const z3Files = JSON.parse(localStorage.getItem("csvZ3Files") || "[]");

  // SA + Z3 ‚Üí Viewer
  const allCsv = [...saFiles, ...z3Files];
  localStorage.setItem("csvFilesList", JSON.stringify(allCsv));

  const index = allCsv.findIndex(f => f.id === id);
  localStorage.setItem("csvFileIndex", index);

  window.open(`${viewer}?fileId=${id}&fileName=${encodeURIComponent(name)}`,'_blank');
}


/* ----------- Filtres ----------- */
function applyFilter(){
  filterStartDate=document.getElementById('startDate').value;
  filterEndDate=document.getElementById('endDate').value;
  const active=document.querySelector('#folderTree .active-folder');
  if(active) active.click();
}
function clearFilter(){
  filterStartDate=''; filterEndDate='';
  document.getElementById('startDate').value=''; document.getElementById('endDate').value='';
  const active=document.querySelector('#folderTree .active-folder');
  if(active) active.click();
}

/* ----------- Modale images + navigation clavier ----------- */
function openModal(id){
  const modal=document.getElementById('imageModal');
  modal.style.display='block';
  document.getElementById('modalFrame').src=`https://drive.google.com/file/d/${id}/preview`;
  currentImageIndex=imageFiles.findIndex(f=>f.id===id);
  document.getElementById('downloadBtn').onclick=()=>window.open(`https://drive.google.com/uc?export=download&id=${id}`,'_blank');
}
function closeModal(){document.getElementById('imageModal').style.display='none';}

document.getElementById('prevBtn').onclick=()=>{if(currentImageIndex>0) openModal(imageFiles[--currentImageIndex].id);};
document.getElementById('nextBtn').onclick=()=>{if(currentImageIndex<imageFiles.length-1) openModal(imageFiles[++currentImageIndex].id);};
window.addEventListener('click',e=>{if(e.target===document.getElementById('imageModal')) closeModal();});

// Navigation clavier quand la modale est ouverte
window.addEventListener('keydown', e=>{
  const modal=document.getElementById('imageModal');
  if(modal.style.display==='block'){
    if(e.key==='ArrowLeft' && currentImageIndex>0){ openModal(imageFiles[--currentImageIndex].id); }
    if(e.key==='ArrowRight' && currentImageIndex<imageFiles.length-1){ openModal(imageFiles[++currentImageIndex].id); }
    if(e.key==='Escape'){ closeModal(); }
  }
});

/* ----------- ZIP overlay + progression + annulation ----------- */
const zipOverlay=document.getElementById('zipOverlay');
const zipProgress=document.getElementById('zipProgress');
const zipCounter=document.getElementById('zipCounter');
const zipFileName=document.getElementById('zipFileName');
const zipTime=document.getElementById('zipTime');
const zipClose=document.getElementById('zipClose');
let zipCancelled=false, zipStartTime=0;

function sanitizeFileName(name){ return name.replace(/[\/\:*?"<>|]/g,"_"); }

function showZipOverlay(name){
  zipCancelled=false;
  zipOverlay.style.display='flex';
  zipFileName.textContent=name;
  zipProgress.style.width='0%';
  zipProgress.textContent='0%';
  zipCounter.textContent='0 / 0 fichiers';
  zipTime.textContent='Temps restant : --';
  zipStartTime=Date.now();
}
function hideZipOverlay(){zipOverlay.style.display='none';}
function updateZipProgress(pct,current,total,sizeAccum){
  zipProgress.style.width=pct+'%';
  zipProgress.textContent=pct+'%';
  zipCounter.textContent=`${current} / ${total} fichiers`;
  if(current>0){
    const elapsed=(Date.now()-zipStartTime)/1000;
    const speedFiles=current/elapsed;
    const speedKB=(sizeAccum/1024)/elapsed;
    const remainingFiles=total-current;
    const remainingTime=remainingFiles/Math.max(speedFiles,0.0001);
    const mins=Math.floor(remainingTime/60);
    const secs=Math.round(remainingTime%60);
    zipTime.textContent=`Temps restant : ${mins>0?mins+'m ':''}${secs}s (${speedFiles.toFixed(1)} fichiers/s, ${Math.max(0,speedKB).toFixed(0)} Ko/s)`;
  }
}
zipClose.onclick=()=>{zipCancelled=true;hideZipOverlay();alert("Pr√©paration ZIP annul√©e.");};

document.getElementById('downloadFolderBtn').onclick=async()=>{
  const active=document.querySelector('#folderTree .active-folder');
  if(!active){alert("S√©lectionnez un dossier !"); return;}
  const folderId=localStorage.getItem('lastFolderId');
  const folderName=active.textContent.trim();
  showZipOverlay(folderName+".zip");
  const files=await fetchFolderContents(folderId);
  if(!files||files.length===0){hideZipOverlay();alert("Aucun fichier dans ce dossier."); return;}
  const zip=new JSZip(); let count=0; let doneSize=0;
  for(const f of files){
    if(zipCancelled) return;
    try{
      const url=`https://www.googleapis.com/drive/v3/files/${f.id}?alt=media&key=${API_KEY}`;
      const res=await fetch(url);
      if(!res.ok) throw new Error('Fetch media failed: '+res.status);
      const blob=await res.blob();
      zip.file(sanitizeFileName(f.name), blob);
      count++; doneSize += f.size ? parseInt(f.size) : 0;
      updateZipProgress(Math.round((count/files.length)*100), count, files.length, doneSize);
    }catch(e){console.error("Erreur sur",f.name,e);}
  }
  if(zipCancelled) return;
  const content=await zip.generateAsync({type:"blob"});
  saveAs(content, folderName+".zip");
  hideZipOverlay();
};

/* ----------- Tri tableau + recolorisation ----------- */
let currentSort = { col: null, asc: true };

function sortTable(colIndex, type) {
  const table = document.getElementById("csvTable");
  const tbody = table.tBodies[0];
  const rows = Array.from(tbody.querySelectorAll("tr"));

  if (currentSort.col === colIndex) {
    currentSort.asc = !currentSort.asc;
  } else {
    currentSort.col = colIndex;
    currentSort.asc = true;
  }

  rows.sort((a, b) => {
    let aText = a.cells[colIndex]?.textContent.trim() || "";
    let bText = b.cells[colIndex]?.textContent.trim() || "";
    if (type === "number") {
      aText = parseFloat(aText) || 0;
      bText = parseFloat(bText) || 0;
    } else if (type === "date") {
      aText = new Date(aText).getTime() || 0;
      bText = new Date(bText).getTime() || 0;
    }
    if (aText < bText) return currentSort.asc ? -1 : 1;
    if (aText > bText) return currentSort.asc ? 1 : -1;
    return 0;
  });

  tbody.innerHTML = "";
  rows.forEach(r => tbody.appendChild(r));

  // mise √† jour des fl√®ches
  document.querySelectorAll("thead th .sort-arrow").forEach(span => span.textContent = "");
  const arrow = table.tHead.rows[0].cells[colIndex].querySelector(".sort-arrow");
  if (arrow) arrow.textContent = currentSort.asc ? "‚ñ≤" : "‚ñº";
}

/* ----------- Ic√¥nes calendrier cliquables ----------- */
document.getElementById("iconStart").onclick=()=>document.getElementById("startDate").showPicker?.()||document.getElementById("startDate").focus();
document.getElementById("iconEnd").onclick=()=>document.getElementById("endDate").showPicker?.()||document.getElementById("endDate").focus();

/* ----------- Menu secret (th√®mes) ----------- */
document.getElementById("secretBtn").onclick=()=>{
  const menu=document.getElementById("themeMenu");
  if(menu.style.display==="block"){ closeThemeMenu(); }
  else { menu.style.display="block"; resetThemeMenuTimer(); }
};
function resetThemeMenuTimer(){ clearTimeout(themeMenuTimer); themeMenuTimer=setTimeout(closeThemeMenu,10000); }
function closeThemeMenu(){ document.getElementById("themeMenu").style.display="none"; clearTimeout(themeMenuTimer); }

/* ----------- Th√®mes + persistance (+ lignes du tableau) ----------- */
function setTheme(theme){
  const r=document.documentElement;
  const logo=document.getElementById("mainLogo");
  logo.style.display=(theme==="orange")?"block":"none";
  localStorage.setItem("selectedTheme",theme);

  if(theme==="orange"){
    r.style.setProperty("--accent","#ff7043");
    r.style.setProperty("--accent-darker","#e64a19");
    r.style.setProperty("--accent-muted","#ffccbc");
    r.style.setProperty("--bg","#fff5f5");
    r.style.setProperty("--panel","#ffffff");
    r.style.setProperty("--sidebar-bg","#ffe5d9");
    r.style.setProperty("--danger","#d84315");
    r.style.setProperty("--text","#333");
    r.style.setProperty("--row-even","#ffe5d9");
    r.style.setProperty("--row-odd","#fff5f5");
  }
  if(theme==="blue"){
    r.style.setProperty("--accent","#2196f3");
    r.style.setProperty("--accent-darker","#1976d2");
    r.style.setProperty("--accent-muted","#bbdefb");
    r.style.setProperty("--bg","#e3f2fd");
    r.style.setProperty("--panel","#ffffff");
    r.style.setProperty("--sidebar-bg","#bbdefb");
    r.style.setProperty("--danger","#0d47a1");
    r.style.setProperty("--text","#0d47a1");
    r.style.setProperty("--row-even","#bbdefb");
    r.style.setProperty("--row-odd","#e3f2fd");
  }
  if(theme==="green"){
    r.style.setProperty("--accent","#4caf50");
    r.style.setProperty("--accent-darker","#2e7d32");
    r.style.setProperty("--accent-muted","#c8e6c9");
    r.style.setProperty("--bg","#f1f8e9");
    r.style.setProperty("--panel","#ffffff");
    r.style.setProperty("--sidebar-bg","#c8e6c9");
    r.style.setProperty("--danger","#1b5e20");
    r.style.setProperty("--text","#1b5e20");
    r.style.setProperty("--row-even","#c8e6c9");
    r.style.setProperty("--row-odd","#f1f8e9");
  }
  if(theme==="purple"){
    r.style.setProperty("--accent","#9c27b0");
    r.style.setProperty("--accent-darker","#6a1b9a");
    r.style.setProperty("--accent-muted","#e1bee7");
    r.style.setProperty("--bg","#f3e5f5");
    r.style.setProperty("--panel","#ffffff");
    r.style.setProperty("--sidebar-bg","#e1bee7");
    r.style.setProperty("--danger","#4a148c");
    r.style.setProperty("--text","#4a148c");
    r.style.setProperty("--row-even","#e1bee7");
    r.style.setProperty("--row-odd","#f3e5f5");
  }
  if(theme==="bordeaux"){
    r.style.setProperty("--accent","#800020");
    r.style.setProperty("--accent-darker","#4b0014");
    r.style.setProperty("--accent-muted","#d7a1a9");
    r.style.setProperty("--bg","#fff0f2");
    r.style.setProperty("--panel","#ffffff");
    r.style.setProperty("--sidebar-bg","#f3cdd3");
    r.style.setProperty("--danger","#600018");
    r.style.setProperty("--text","#4b0014");
    r.style.setProperty("--row-even","#f3cdd3");
    r.style.setProperty("--row-odd","#fff0f2");
  }
}

/* ----------- üî• V√©rif CSV du jour pour "Temp" ----------- */
async function checkTra√ßaTempToday(parentLi, tracatempId) {
  const today = new Date();
  const yyyymmdd =
    today.getFullYear().toString() +
    String(today.getMonth() + 1).padStart(2, "0") +
    String(today.getDate()).padStart(2, "0");

  const files = await fetchFolderContents(tracatempId);
  // accepter tout CSV contenant la date du jour
  const todayFile = files.find(f => f.name.includes(yyyymmdd) && f.name.endsWith(".csv"));
  if (!todayFile) return;

  try {
    const url = `https://www.googleapis.com/drive/v3/files/${todayFile.id}?alt=media&key=${API_KEY}`;
    const res = await fetch(url);
    const text = await res.text();

    // lire les derni√®res lignes
    const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");
    const lastLine = lines[lines.length - 1];
    if (!lastLine) return;

    // Nettoyage : enlever guillemets et espaces
    const cols = lastLine.split(",").map(c => c.replace(/"/g, "").trim());

    const v4 = parseFloat(cols[3]);
    const v6 = parseFloat(cols[5]);

    if ((v4 && v4 > FLAME_THRESHOLD) || (v6 && v6 > FLAME_THRESHOLD)) {
      markFolderWithFlame(parentLi);
    }

  } catch (e) {
    console.error("Erreur lecture CSV dans Temp", e);
  }
}

function markFolderWithFlame(li) {
  const span = li.querySelector(".folder-name");
  // ‚úÖ V√©rifie s'il y a d√©j√† une flamme (√©vite les doublons)
  if (span && !span.querySelector(".flame")) {
    span.innerHTML = `<span class="flame">üî•</span> ` + span.innerHTML;
  }
  // ‚úÖ Propagation aux parents
  if (li.parentElement && li.parentElement.closest("li")) {
    markFolderWithFlame(li.parentElement.closest("li"));
  }
}


/* ----------- Init ----------- */
window.onload=()=>{
  updateNetworkStatus();
  const savedTheme=localStorage.getItem("selectedTheme")||"orange";
  setTheme(savedTheme);

  // bouton "T√©l√©charger le dossier" cach√© par d√©faut tant qu'aucun contenu
  document.getElementById("downloadFolderBtn").style.display="none";

  loadRootFolders();
  const last=localStorage.getItem('lastFolderId');
  if(last){
    const temp={dataset:{id:last}, querySelector:()=>({classList:{add:()=>{}}})};
    loadFolderFilesOnClick(temp);
  }
};
</script>
</body>
</html>




















