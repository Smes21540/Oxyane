<!DOCTYPE html>
<html lang="fr">
<head>
  <!-- === PARTIE 1 : DOCTYPE + HEAD (Librairies) === -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Graphique CSV</title>

  <!-- Librairies -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

  <!-- === PARTIE 2 : Styles CSS === -->
  <style>
    :root{
      --bg:#fff5f5; --panel:#ffffff; --accent:#ff7043; --accent-darker:#e64a19;
      --accent-muted:#ffccbc; --danger:#d84315; --text:#333; --shadow:rgba(0,0,0,0.1);
    }
    body{font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;background:var(--bg);margin:0;padding:5px 20px;color:var(--danger);display:flex;flex-direction:column;min-height:100vh;}
    .header{position:relative;display:flex;align-items:center;justify-content:center;margin-bottom:10px;}
    .header .logo{height:60px;width:auto;}
    #fileNameContainer{position:absolute;right:0;top:0;text-align:right;}
    #fileName,#lineCount{color:var(--accent-darker);}
    #fileName{font-size:24px;font-weight:bold;white-space:nowrap;max-width:300px;overflow:hidden;text-overflow:ellipsis;display:none;}
    #lineCount{font-size:12px;display:none;}
    .controls{display:flex;justify-content:center;gap:10px;margin-bottom:10px;flex-wrap:wrap;}
    button{background:var(--accent);color:#fff;border:none;cursor:pointer;font-weight:bold;padding:8px 12px;border-radius:6px;font-size:13px;transition:background-color .3s, transform .2s;}
    button:hover{background:var(--accent-darker);transform:scale(1.05);}
    button:disabled{background:#ccc;color:#666;cursor:not-allowed;transform:none;}
    .graph-wrapper{display:flex;align-items:center;justify-content:center;gap:20px;margin-bottom:40px;}
    .graph-side{display:flex;flex-direction:column;gap:10px;}
    #myChart {
  width: 100%;
  aspect-ratio: 16 / 9;
  max-height: 800px;
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 4px 12px var(--shadow);
  display: block;
  margin: 0 auto;
}

    #zoomInfo{position:absolute;top:80px;right:20px;background:rgba(255,255,255,0.9);border:1px solid var(--accent);border-radius:6px;padding:6px 10px;font-size:12px;color:var(--accent-darker);font-weight:bold;z-index:10;pointer-events:none;}
    #spinner{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:50px;height:50px;border:6px solid #f3f3f3;border-top:6px solid var(--accent);border-radius:50%;animation:spin 1s linear infinite;z-index:2000;}
    @keyframes spin{0%{transform:translate(-50%,-50%) rotate(0deg);}100%{transform:translate(-50%,-50%) rotate(360deg);}}
    #errorBox{display:none;position:fixed;top:40%;left:50%;transform:translate(-50%,-50%);background:var(--accent-muted);padding:20px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,0.2);z-index:2001;text-align:center;color:var(--danger);font-weight:bold;}
    #secretBtn{position:fixed;bottom:10px;right:10px;width:25px;height:25px;opacity:0;cursor:pointer;z-index:2000;}
    #themeMenu{display:none;position:fixed;bottom:50px;right:10px;background:var(--panel);border:2px solid var(--accent);border-radius:8px;box-shadow:0 4px 12px var(--shadow);padding:10px;z-index:2001;min-width:150px;}
    #themeMenu h3{margin:0 0 8px 0;font-size:14px;color:var(--accent);}
    #themeMenu .closeMenu{position:absolute;top:5px;right:8px;font-size:14px;cursor:pointer;color:var(--accent);}
    #themeMenu .closeMenu:hover{color:var(--accent-darker);}
    #themeMenu button{display:block;width:100%;margin:4px 0;padding:6px;border:none;border-radius:6px;background:var(--accent);color:#fff;cursor:pointer;font-size:13px;}
    #themeMenu button:hover{background:var(--accent-darker);}
    #dayModal{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--panel);border:2px solid var(--accent);border-radius:10px;box-shadow:0 4px 12px var(--shadow);padding:20px;z-index:3000;text-align:center;min-width:270px;}
    #dayModal h3{margin:0;color:var(--accent);font-size:16px;}
    #dayModal input{width:80px;text-align:center;padding:6px;margin:15px 0;font-size:15px;border:1px solid #ddd;border-radius:6px;}
    #dayModal .actions{margin-top:14px;display:flex;justify-content:center;gap:10px;}
    #dayModal button{margin:0;padding:8px 12px;border-radius:6px;}
    #dayModal .ghost{background:#eee;color:#333;}
    @media (max-width:600px){#myChart{width:100%;}}
  </style>
</head>
<body>
  <!-- === PARTIE 3 : Header === -->
  <div class="header">
    <img src="img/logo.png" alt="Logo" class="logo" />
    <div id="fileNameContainer">
      <div id="fileName"></div>
      <div id="lineCount"></div>
    </div>
  </div>

  <!-- === PARTIE 4 : Contr√¥les === -->
  <div class="controls">
    <button id="backBtn">‚¨ÖÔ∏è Retour</button>
    <button id="exportPDF" style="display:none;">üìÑ Exporter PDF</button>
    <button id="resetZoom" style="display:none;">üîÑ R√©initialiser zoom</button>
  </div>

  <!-- === PARTIE 5 : S√©lecteurs === -->
  <div class="controls" id="columnSelectors" style="display:none;">
    <select id="xColumn"></select>
    <select id="yColumns" multiple></select>
    <button id="drawChartBtn">üìä Afficher courbes</button>
  </div>

    <!-- === PARTIE 6 : Zone Graphique === -->
  <div class="graph-wrapper">
    <div class="graph-side">
      <button id="extendPrev">‚¨ÖÔ∏è √âtendre veille</button>
      <button id="panPrev">‚è™ Avant</button>
    </div>

    <div style="flex:1; display:flex; flex-direction:column; align-items:center;">
      <canvas id="myChart" width="1600" height="800"></canvas>
      <div id="dateLabels"
           style="text-align:center; margin-top:8px; font-weight:bold; color:var(--danger);"></div>
    </div>

    <div class="graph-side">
      <button id="extendNext">√âtendre lendemain ‚û°Ô∏è</button>
      <button id="panNext">‚è© Apr√®s</button>
    </div>
  </div>


  <!-- === PARTIE 7 : Aides/√©tats === -->
  <div id="zoomInfo">üîç S√©lectionner une zone avec le clic gauche pour zoomer</div>
  <div id="spinner"></div>
  <div id="errorBox">
    ‚ö†Ô∏è Impossible de charger le fichier.<br>V√©rifiez la connexion ou r√©essayez plus tard.<br><br>
    <button onclick="window.location.reload()">R√©essayer</button>
  </div>

  <!-- === PARTIE 8 : Menu Th√®mes === -->
  <div id="secretBtn" title=" "></div>
  <div id="themeMenu">
    <span class="closeMenu" onclick="closeThemeMenu()">‚ùå</span>
    <h3>Choisir un th√®me</h3>
    <button onclick="setTheme('orange')">Orange (d√©faut)</button>
    <button onclick="setTheme('blue')">Bleu</button>
    <button onclick="setTheme('green')">Vert</button>
    <button onclick="setTheme('purple')">Violet</button>
    <button onclick="setTheme('bordeaux')">Bordeaux</button>
  </div>

  <!-- === PARTIE 9 : Modal jours === -->
  <div id="dayModal" role="dialog" aria-modal="true" aria-labelledby="dayModalTitle">
    <h3 id="dayModalTitle">Combien de jours souhaitez-vous charger&nbsp;?</h3>
    <input type="number" id="dayCount" value="1" min="1" />
    <div class="actions">
      <button id="confirmDay">OK</button>
      <button class="ghost" onclick="closeDayModal()">Annuler</button>
    </div>
  </div>

   <script>
  /* ===================== CONFIG / STATE ===================== */
  const API_KEY='AIzaSyCbEV3CS9bOcxq5eK-QXbjczGHjvzyXS6M';
  let csvData=[], chart, currentX="", currentY=[];
  let baseFileName="", baseFileId="", headers=[], timeField="", baseDateYYYYMMDD="";
  let colors=[]; let themeMenuTimer;
  let loadedDays=new Set(); let saMeta=null;

  /* ===================== THEME ===================== */
  function applyThemeVars(vars){
    const r=document.documentElement;
    Object.entries(vars).forEach(([k,v])=>r.style.setProperty(k,v));
    colors = buildPalette();
    if(chart){
      chart.data.datasets.forEach((ds,i)=>{
        const c=colors[i%colors.length];
        ds.borderColor=c; ds.pointBackgroundColor=c; ds.pointBorderColor=c;
      });
      chart.update('none');
    }
  }
  function setTheme(theme){
    localStorage.setItem("selectedTheme",theme);
    if(theme==="orange") applyThemeVars({"--accent":"#ff7043","--accent-darker":"#e64a19","--accent-muted":"#ffccbc","--bg":"#fff5f5","--panel":"#ffffff","--danger":"#d84315","--text":"#333"});
    if(theme==="blue")   applyThemeVars({"--accent":"#2196f3","--accent-darker":"#1976d2","--accent-muted":"#bbdefb","--bg":"#e3f2fd","--panel":"#ffffff","--danger":"#0d47a1","--text":"#0d47a1"});
    if(theme==="green")  applyThemeVars({"--accent":"#4caf50","--accent-darker":"#2e7d32","--accent-muted":"#c8e6c9","--bg":"#f1f8e9","--panel":"#ffffff","--danger":"#1b5e20","--text":"#1b5e20"});
    if(theme==="purple") applyThemeVars({"--accent":"#9c27b0","--accent-darker":"#6a1b9a","--accent-muted":"#e1bee7","--bg":"#f3e5f5","--panel":"#ffffff","--danger":"#4a148c","--text":"#4a148c"});
    if(theme==="bordeaux")applyThemeVars({"--accent":"#800020","--accent-darker":"#4b0014","--accent-muted":"#d7a1a9","--bg":"#fff0f2","--panel":"#ffffff","--danger":"#600018","--text":"#4b0014"});
  }
  document.getElementById("secretBtn").onclick=()=>{
    const m=document.getElementById("themeMenu");
    if(m.style.display==="block"){closeThemeMenu();}else{m.style.display="block";resetThemeMenuTimer();}
  };
  function resetThemeMenuTimer(){clearTimeout(themeMenuTimer);themeMenuTimer=setTimeout(closeThemeMenu,10000);}
  function closeThemeMenu(){document.getElementById("themeMenu").style.display="none";clearTimeout(themeMenuTimer);}
  function getCSSVar(v){return getComputedStyle(document.documentElement).getPropertyValue(v).trim();}
  function hexToRgb(hex){hex=hex.replace('#','');if(hex.length===3){hex=hex.split('').map(h=>h+h).join('');}const n=parseInt(hex,16);return {r:(n>>16)&255,g:(n>>8)&255,b:n&255};}
  function buildPalette(){const a=getCSSVar('--accent'),d=getCSSVar('--danger');return [a,d,"#3380ff","#4caf50","#8e44ad","#ff33a6","#33cccc","#ffc300"];}

  /* ===================== SPINNER + ERROR ===================== */
  function showSpinner(){document.getElementById('spinner').style.display='block';}
  function hideSpinner(){document.getElementById('spinner').style.display='none';}
  function showError(){hideSpinner();document.getElementById('errorBox').style.display='block';}

  /* ===================== UTILS ===================== */
  function getParam(n){return new URLSearchParams(window.location.search).get(n);}
  function parseSAFileName(fname){const m=fname.match(/^SA(\d+)_(\d{8})/i);if(!m) return null;return {num:m[1].padStart(5,"0"),date:m[2]};}
  function shiftDate(yyyymmdd,delta){
    const y=+yyyymmdd.slice(0,4), m=+yyyymmdd.slice(4,6)-1, d=+yyyymmdd.slice(6,8);
    const dt=new Date(y,m,d); dt.setDate(dt.getDate()+delta);
    return dt.getFullYear()+String(dt.getMonth()+1).padStart(2,"0")+String(dt.getDate()).padStart(2,"0");
  }
  function makeSortKey(iso,t){return new Date(`${iso}T${t||"00:00:00"}`).getTime();}
function dedupeHeaders(arr) {
  const hc = {};
  return arr.map(h => {
    const k = (h == null ? "" : String(h));
    hc[k] = (hc[k] || 0) + 1;

    // R√®gle sp√©ciale uniquement pour les colonnes contenant "SONDE"
    if (k.toUpperCase().includes("SONDE")) {
      if (hc[k] === 1) return `${k} Consigne`;
      if (hc[k] === 2) return `${k} Valeur`;
      return `${k}_${hc[k]}`;
    }

    // Sinon : on garde le nom original, en ajoutant un suffixe si doublon
    return hc[k] === 1 ? k : `${k}_${hc[k]}`;
  });
}

  function capitalizeFirst(s){return s? s.charAt(0).toUpperCase()+s.slice(1):s;}
  function dayLabelFR(ts){
    const nd=new Date(ts);
    return capitalizeFirst(nd.toLocaleDateString('fr-FR',{weekday:'long',day:'numeric',month:'long',year:'numeric'}));
  }

  /* ===================== FETCH CSV ===================== */
  async function loadCSVByFileId(fileId){
    try{
      showSpinner();
      const url=`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media&key=${API_KEY}`;
      const res=await fetch(url);
      if(!res.ok) throw new Error("HTTP "+res.status);
      const text=new TextDecoder('windows-1252').decode(await res.arrayBuffer());
      hideSpinner();
      return Papa.parse(text,{header:false,dynamicTyping:true,skipEmptyLines:true});
    }catch(e){console.error(e);showError();return null;}
  }
  function buildObjectsFromParsedResults(results,hdrs){
    return results.data.slice(1).map(row=>{const o={};row.forEach((v,i)=>o[hdrs[i]]=v);return o;});
  }
  function enrichRowsWithDate(rows,yyyymmdd){
    if(!timeField) return rows;
    const iso=`${yyyymmdd.slice(0,4)}-${yyyymmdd.slice(4,6)}-${yyyymmdd.slice(6,8)}`;
    rows.forEach(r=>{r.__dateISO=iso;r.__sortKey=makeSortKey(iso,r[timeField]);});
    return rows;
  }

  /* ===================== LOAD CSV (base) ===================== */
  async function loadCSVFromDrive(){
    baseFileId=getParam('fileId'); baseFileName=decodeURIComponent(getParam('fileName')||'');
    if(!baseFileId){showError();return;}
    document.getElementById('fileName').textContent=baseFileName;
    document.getElementById('fileName').style.display="block";
    document.getElementById('lineCount').style.display="block";
    document.getElementById('exportPDF').style.display="inline-block";
    document.getElementById('resetZoom').style.display="inline-block";

    const parsed=await loadCSVByFileId(baseFileId); if(!parsed) return;
    headers=dedupeHeaders(parsed.data[0]||[]);
    csvData=buildObjectsFromParsedResults(parsed,headers);
    document.getElementById('lineCount').textContent=csvData.length+" ligne"+(csvData.length>1?"s":"");

    const xSel=document.getElementById('xColumn'), ySel=document.getElementById('yColumns');
    xSel.innerHTML=""; ySel.innerHTML="";
    let defX=headers.find(h=>h.toLowerCase().includes("time")||h.toLowerCase()==="heure");
    headers.forEach(f=>{
      const ox=document.createElement("option"); ox.value=f; ox.text=f; xSel.appendChild(ox);
      const low=f.toLowerCase();
      if(f===defX||/time|date|jour/.test(low)) return;
      const oy=document.createElement("option"); oy.value=f; oy.text=f; ySel.appendChild(oy);
    });
    document.getElementById('columnSelectors').style.display="flex";
    if(defX){document.getElementById('xColumn').value=defX; document.getElementById('xColumn').style.display="none"; timeField=defX;}

    saMeta=parseSAFileName(baseFileName);
    if(saMeta){baseDateYYYYMMDD=saMeta.date; enrichRowsWithDate(csvData,baseDateYYYYMMDD); loadedDays.add(baseDateYYYYMMDD);}
  }

  /* ===================== CHART ===================== */
  function getTimeUnit(range){
    const d=86400000;
    if(range<=d) return {unit:'hour',stepSize:2};
    if(range<=3*d) return {unit:'hour',stepSize:6};
    if(range>=7*d) return {unit:'day',stepSize:1};
    return {unit:'hour',stepSize:4};
  }
  function applyAdaptiveTicks(){
    if(!chart) return;
    const range=chart.scales.x.max-chart.scales.x.min;
    const cfg=getTimeUnit(range);
    chart.options.scales.x.time=chart.options.scales.x.time||{};
    chart.options.scales.x.time.unit=cfg.unit;
    chart.options.scales.x.time.stepSize=cfg.stepSize;
    chart.options.scales.x.ticks.callback=(value)=>{const d=new Date(value);return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;};
    chart.update('none');
  }
  function drawChart(){
    if(!csvData.length||!timeField) return;
    const ctx=document.getElementById('myChart').getContext('2d');

    const allX=csvData.map(r=>r.__sortKey).filter(v=>Number.isFinite(v));
    const minX=Math.min(...allX), maxX=Math.max(...allX);

    const datasets=currentY.map((yCol,i)=>({
      label:yCol,
      data:csvData.map(r=>({x:r.__sortKey,y:r[yCol]})),
      borderColor:colors[i%colors.length], borderWidth:3, fill:false,
      tension:0, pointRadius:0, pointHoverRadius:6,
      pointBackgroundColor:colors[i%colors.length], pointBorderColor:colors[i%colors.length]
    }));

    const dayBackgroundPlugin={
      id:'dayBackground',
      beforeDraw(chart){
        const {scales:{x},chartArea}=chart;
        if(!x||!isFinite(x.min)||!isFinite(x.max)) return;
        const oneDay=86400000;
        let start=new Date(x.min); start.setHours(0,0,0,0);
        let toggle=false;
        const ctx=chart.ctx; ctx.save();

        for(let d=start.getTime(); d<x.max; d+=oneDay){
          const from=x.getPixelForValue(d), to=x.getPixelForValue(d+oneDay);
          ctx.fillStyle=toggle? (getCSSVar('--accent-muted')||'rgba(255,112,67,0.12)') : 'rgba(0,0,0,0.02)';
          ctx.fillRect(from, chartArea.top, to-from, chartArea.bottom-chartArea.top);
          toggle=!toggle;
        }
        ctx.restore();

        const labels=[];
        for(let d=start.getTime(); d<x.max; d+=oneDay){labels.push(dayLabelFR(d));}
        const dl=document.getElementById('dateLabels'); if(dl) dl.textContent = labels.join(" | ");
      }
    };

    if(chart) chart.destroy();
    chart=new Chart(ctx,{
      type:'line',
      data:{datasets},
      options:{
        responsive:true,
        maintainAspectRatio:false,
        interaction:{mode:'nearest',axis:'x',intersect:false},
        plugins:{
          legend:{position:'top'},
          datalabels:{display:false},
          zoom:{
            zoom:{wheel:{enabled:true,modifierKey:'ctrl'},pinch:{enabled:true},drag:{enabled:true,mode:'x'}},
            pan:{enabled:true,mode:'x'}
          },
          tooltip:{callbacks:{title:(items)=>{if(!items?.length) return '';const d=new Date(items[0].parsed.x);return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;}}}
        },
        scales:{
          x:{
            type:'time',
            min:Number.isFinite(minX)?minX:undefined,
            max:Number.isFinite(maxX)?maxX:undefined,
            time:{unit:'hour',tooltipFormat:'HH:mm',displayFormats:{hour:'HH:mm',minute:'HH:mm'}},
            ticks:{autoSkip:true,callback:(value)=>{const d=new Date(value);return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;}}
          },
          y:{title:{display:true,text:'Valeurs'}}
        }
      },
      plugins:[ChartDataLabels,dayBackgroundPlugin]
    });

    chart.update();
    applyAdaptiveTicks();
  }

  /* ===================== UI ===================== */
  document.getElementById('backBtn').onclick=()=>window.close();
  document.getElementById('drawChartBtn').onclick=()=>{
    currentX=document.getElementById('xColumn').value;
    currentY=Array.from(document.getElementById('yColumns').selectedOptions).map(o=>o.value);
    if(!currentY.length){alert("Choisissez au moins une colonne pour Y.");return;}
    drawChart();
  };
  document.getElementById('resetZoom').onclick=()=>{
    if(!chart) return;
    chart.resetZoom();
    chart.options.scales.x.min=undefined;
    chart.options.scales.x.max=undefined;
    applyAdaptiveTicks();
  };

  /* ===================== EXTEND / PAN ===================== */
  async function loadDayIfAvailable(yyyymmdd){
    if(loadedDays.has(yyyymmdd)) return true;
    const list=JSON.parse(localStorage.getItem("csvFilesList")||"[]");
    if(!saMeta) return false;
    const name=`SA${saMeta.num}_${yyyymmdd}.csv`;
    const f=list.find(x=>x.name===name);
    if(!f) return false;
    const parsed=await loadCSVByFileId(f.id); if(!parsed) return false;
    const rows=buildObjectsFromParsedResults(parsed,headers); enrichRowsWithDate(rows,yyyymmdd);
    csvData=csvData.concat(rows); loadedDays.add(yyyymmdd); return true;
  }

  async function panAndLoad(direction){
    if(!chart || !saMeta) return;

    const sc = chart.scales.x;
    const oneDay = 86400000;
    const currMin = (chart.options.scales.x.min!=null)? chart.options.scales.x.min : sc.min;
    const currMax = (chart.options.scales.x.max!=null)? chart.options.scales.x.max : sc.max;
    const targetMin = currMin + direction*oneDay;
    const targetMax = currMax + direction*oneDay;

    const targetDate = shiftDate(saMeta.date, direction);
    const loaded = await loadDayIfAvailable(targetDate);

    if (loaded) {
      csvData.sort((a,b)=>(a.__sortKey||0)-(b.__sortKey||0));

      if (currentY.length) {
        chart.data.datasets = currentY.map((yCol,i)=>({
          label:yCol,
          data:csvData.map(r=>({x:r.__sortKey,y:r[yCol]})),
          borderColor:colors[i%colors.length], borderWidth:3, fill:false,
          tension:0, pointRadius:0, pointHoverRadius:6,
          pointBackgroundColor:colors[i%colors.length], pointBorderColor:colors[i%colors.length]
        }));
      }

      saMeta.date = targetDate;
      chart.options.scales.x.min = targetMin;
      chart.options.scales.x.max = targetMax;
      chart.options.scales.y.min = undefined;
      chart.options.scales.y.max = undefined;

      chart.update('none');
      applyAdaptiveTicks();
    } else {
      const d=`${targetDate.slice(6,8)}/${targetDate.slice(4,6)}/${targetDate.slice(0,4)}`;
      alert(`Aucun fichier disponible pour la date ${d}`);
      return;
    }
  }

  document.getElementById('panPrev').onclick = ()=> panAndLoad(-1);
  document.getElementById('panNext').onclick = ()=> panAndLoad(+1);

  async function extendDays(direction,days){
    if(!saMeta) return;
    for(let i=1;i<=days;i++){
      const target=shiftDate(saMeta.date,direction>0?i:-i);
      await loadDayIfAvailable(target);
    }
    csvData.sort((a,b)=>(a.__sortKey||0)-(b.__sortKey||0));
    if(currentY.length) drawChart();
  }

  let modalResolve=null, modalDirection=0;
  function openDayModal(initial,dir){
    modalDirection=dir;
    const m=document.getElementById('dayModal');
    const inp=document.getElementById('dayCount');
    inp.value=initial||1; m.style.display='block'; inp.focus(); inp.select();
    return new Promise(res=>{modalResolve=res;});
  }
  function closeDayModal(){document.getElementById('dayModal').style.display='none'; if(modalResolve){modalResolve(null); modalResolve=null;}}
  document.getElementById('confirmDay').onclick=()=>{
    const n=parseInt(document.getElementById('dayCount').value,10);
    document.getElementById('dayModal').style.display='none';
    if(modalResolve){modalResolve(isNaN(n)?null:{n,dir:modalDirection}); modalResolve=null;}
  };
  document.getElementById('extendPrev').onclick=async()=>{ const res=await openDayModal(1,-1); if(res&&res.n>0) extendDays(-1,res.n); };
  document.getElementById('extendNext').onclick=async()=>{ const res=await openDayModal(1,+1); if(res&&res.n>0) extendDays(+1,res.n); };

  /* ===================== EXPORT PDF ===================== */
  document.getElementById('exportPDF').onclick = () => {
    if (!chart) { alert("Aucun graphique √† exporter."); return; }

    let jsPDFConstructor = null;
    if (window.jspdf && window.jspdf.jsPDF) jsPDFConstructor = window.jspdf.jsPDF;
    else if (window.jsPDF) jsPDFConstructor = window.jsPDF;
    if (!jsPDFConstructor) { alert("jsPDF n‚Äôest pas charg√© !"); return; }

    const pdf = new jsPDFConstructor({ orientation: 'landscape' });
    const pageWidth = pdf.internal.pageSize.getWidth();

    const csvName = (getParam('fileName') || '').split('\\').pop() || '';
    let titleText = csvName;
    let pdfFileName = csvName.replace(/\.csv$/i, '.pdf');

    if (csvName.startsWith("Z")) {
      const matchZ = csvName.match(/^Z\d+(\d{2})_(\d{8})/);
      if (matchZ) {
        const xx = parseInt(matchZ[1],10).toString();
        const d = matchZ[2];
        titleText = `Historique S√©choir ${xx} - ${d.slice(6,8)}/${d.slice(4,6)}/${d.slice(0,4)}`;
      }
    } else {
      const match = csvName.match(/^SA(\d+)_([0-9]{8})/);
      if (match) {
        const num = parseInt(match[1],10);
        const d = match[2];
        titleText = num>0 ? `S√©choir ${num} - ${d.slice(6,8)}/${d.slice(4,6)}/${d.slice(0,4)}` : `${d.slice(6,8)}/${d.slice(4,6)}/${d.slice(0,4)}`;
        const numTwoDigits = String(num).padStart(2,'0');
        pdfFileName = num>0 ? `S√©choir-${numTwoDigits}_${d}.pdf` : `${d}.pdf`;
      }
    }

    const danger = getCSSVar('--danger') || '#d84315';
    const { r, g, b } = hexToRgb(danger);
    const pdfSafeGrey = {r:50,g:50,b:50};

    pdf.setFontSize(14);
    pdf.setTextColor(r, g, b);
    const lines = pdf.splitTextToSize(titleText, pageWidth - 20);
    const titleY = 12;
    pdf.text(lines, 14, titleY);

    const canvas = chart.canvas;
    const pageHeight = pdf.internal.pageSize.getHeight();
    const scale = Math.min((pageWidth-20)/canvas.width, (pageHeight-60)/canvas.height);
    const chartX = (pageWidth - canvas.width*scale)/2;
    const chartY = titleY + 8 + lines.length*5;
    pdf.addImage(
      canvas.toDataURL('image/png'),
      'PNG',
      chartX,
      chartY,
      canvas.width*scale,
      canvas.height*scale
    );

    const dateLabels = document.getElementById('dateLabels')?.textContent || "";
    if (dateLabels) {
      pdf.setFontSize(10);
      pdf.setTextColor(pdfSafeGrey.r, pdfSafeGrey.g, pdfSafeGrey.b);
      const yPos = chartY + canvas.height*scale + 15;
      const wrapped = pdf.splitTextToSize(dateLabels, pageWidth - 20);
      pdf.text(wrapped, pageWidth/2, yPos, { align: "center" });
    }

    pdf.save(pdfFileName);
  };

  /* ===================== INIT ===================== */
  (async function(){
    setTheme(localStorage.getItem("selectedTheme")||"orange");
    await loadCSVFromDrive();
    document.getElementById('zoomInfo').style.display='block';
    setTimeout(()=>{document.getElementById('zoomInfo').style.display='none';},5000);

    if(!document.getElementById('dateLabels')){
      const dl=document.createElement("div");
      dl.id="dateLabels";
      dl.style.textAlign="center";
      dl.style.marginTop="10px";
      dl.style.fontSize="13px";
      dl.style.color=getCSSVar('--text');
      document.querySelector(".graph-wrapper").after(dl);
    }
  })();
</script>

</body>
</html>
