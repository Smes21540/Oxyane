<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Courbes Gaz</title>

  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üåΩ</text></svg>">

  <!-- Librairies -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

  <style>
    :root{
      --bg:#fff5f5; --panel:#ffffff; --accent:#ff7043; --accent-darker:#e64a19;
      --accent-muted:#fff9f7; --danger:#d84315; --text:#333; --shadow:rgba(0,0,0,0.1);
    }

    body{
      font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;
      background:var(--bg); margin:0; padding:5px 20px; color:var(--danger);
      display:flex; flex-direction:column; min-height:100vh;
    }

    .header{position:relative;display:flex;align-items:center;justify-content:center;margin-bottom:10px;}
    .header .logo{height:60px;width:auto;}
    #fileNameContainer{position:absolute;right:0;top:0;text-align:right;}
    #fileName,#lineCount{color:var(--accent-darker);}
    #fileName{font-size:24px;font-weight:bold;white-space:nowrap;max-width:300px;overflow:hidden;text-overflow:ellipsis;display:none;}
    #lineCount{font-size:12px;display:none;}

    .controls{
      display:flex; justify-content:center; align-items:center;
      gap:10px; margin-bottom:10px; flex-wrap:wrap;
    }
    button{
      background:var(--accent); color:#fff; border:none; cursor:pointer;
      font-weight:bold; padding:8px 12px; border-radius:6px; font-size:13px;
      transition:background-color .3s, transform .2s;
    }
    button:hover{background:var(--accent-darker);transform:scale(1.05);}
    button:disabled{background:#ccc;color:#666;cursor:not-allowed;transform:none;}
    .controls button{flex:0 0 auto; width:auto; display:inline-block;}

    .graph-wrapper {
      display:flex;
      align-items:stretch;
      justify-content:center;
      gap:20px;
      margin-bottom:40px;
      height:700px;
    }
    .graph-side {
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
    }
    #myChart {
      width:100%;
      aspect-ratio:16/9;
      max-height:700px;
      background:#fff;
      border-radius:8px;
      box-shadow:0 4px 12px var(--shadow);
      display:block;
      margin:0 auto;
    }

    .y-columns {
      display:flex;
      flex-direction:column;
      gap:4px;
      height:auto;
      max-height:700px;
      overflow-y:auto;
      border:1px solid #ddd;
      padding:6px;
      border-radius:6px;
      background:var(--panel);
      scrollbar-width:thin;
      width:220px;
    }
    .y-columns::-webkit-scrollbar{width:6px;}
    .y-columns::-webkit-scrollbar-thumb{background:var(--accent);border-radius:4px;}
    .y-columns::-webkit-scrollbar-track{background:#f0f0f0;}
    .y-columns label{
      display:flex; align-items:center; gap:6px; padding:4px 6px; border-radius:4px; cursor:pointer;
      font-size:13px; background:var(--accent-muted); user-select:none; white-space:nowrap; justify-content:flex-start;
    }
    .y-columns input[type="checkbox"]{accent-color:var(--accent);}

    #columnSelectors{align-items:center;}

    #extendPrev,#extendNext,#panPrev,#panNext{display:none !important;}

    #currentFolderName {
      position:absolute;
      left:10px;
      top:10px;
      font-size:22px;
      font-weight:bold;
      color:var(--accent);
      white-space:nowrap;
      max-width:500px;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    #zoomInfo{
      position:absolute; top:80px; right:20px; background:rgba(255,255,255,0.9);
      border:1px solid var(--accent); border-radius:6px; padding:6px 10px; font-size:12px;
      color:var(--accent-darker); font-weight:bold; z-index:10; pointer-events:none;
    }
    #spinner {
      display:none;
      position:fixed;
      top:50%;
      left:50%;
      transform:translate(-50%, -50%);
      z-index:2000;
    }
    .spin-inner {
      width:50px;
      height:50px;
      border:6px solid #ccc;
      border-top:6px solid var(--accent);
      border-radius:50%;
      animation:spin 1s linear infinite;
    }
    @keyframes spin{from{transform:rotate(0deg);}to{transform:rotate(360deg);}}

    #errorBox{
      display:none;position:fixed;top:40%;left:50%;transform:translate(-50%,-50%);
      background:var(--accent-muted);padding:20px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,0.2);
      z-index:2001;text-align:center;color:var(--danger);font-weight:bold;
    }

    #secretBtn{position:fixed;bottom:10px;right:10px;width:25px;height:25px;opacity:0;cursor:pointer;z-index:2000;}
    #themeMenu{
      display:none;position:fixed;bottom:50px;right:10px;background:var(--panel);
      border:2px solid var(--accent);border-radius:8px;box-shadow:0 4px 12px var(--shadow);
      padding:10px;z-index:2001;min-width:150px;
    }
    #themeMenu h3{margin:0 0 8px 0;font-size:14px;color:var(--accent);}
    #themeMenu .closeMenu{position:absolute;top:5px;right:8px;font-size:14px;cursor:pointer;color:var(--accent);}
    #themeMenu .closeMenu:hover{color:var(--accent-darker);}
    #themeMenu button{display:block; width:100%; margin:4px 0; padding:6px; border:none; border-radius:6px;
      background:var(--accent); color:#fff; cursor:pointer; font-size:13px;}
    #themeMenu button:hover{background:var(--accent-darker);}

    @media (max-width:600px){#myChart{width:100%;}}

  </style>
</head>
<body>
  <div class="header">
    <div id="currentFolderName"></div>
    <img src="img/logo.png" alt="Logo" class="logo" />
    <div id="fileNameContainer">
      <div id="fileName"></div>
      <div id="lineCount"></div>
    </div>
  </div>

  <div class="controls">
    <button id="backBtn">‚¨ÖÔ∏è Retour</button>
    <button id="exportPDF" style="display:none;">üìÑ Exporter PDF</button>
    <button id="resetZoom" style="display:none;">üîÑ R√©initialiser zoom</button>
  </div>

  <div class="controls" id="columnSelectors" style="display:none; flex-direction:column; gap:8px;">
    <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
      <select id="xColumn" style="display:none;"></select>
    </div>
  </div>

  <div class="graph-wrapper">
    <div class="graph-side">
      <div id="yColumnsContainer" class="y-columns"></div>
    </div>
    <div style="flex:1; display:flex; flex-direction:column; align-items:center;">
      <canvas id="myChart" width="1400" height="700"></canvas>
      <input type="color" id="colorPicker" style="display:none;" />
    </div>
  </div>

  <div id="zoomInfo">üîç S√©lectionner une zone (drag) pour zoomer, molette+Ctrl pour zoom, Ctrl+clic sur une barre pour changer sa couleur</div>

  <div id="spinner"><div class="spin-inner"></div></div>

  <div id="errorBox">
    ‚ö†Ô∏è Impossible de charger le fichier Gaz.<br>Relance l'export depuis l'explorateur.<br><br>
    <button onclick="window.location.reload()">R√©essayer</button>
  </div>

  <div id="secretBtn" title=" "></div>
  <div id="themeMenu">
    <span class="closeMenu" onclick="closeThemeMenu()">‚ùå</span>
    <h3>Choisir un th√®me</h3>
    <button onclick="setTheme('orange')">Orange (d√©faut)</button>
    <button onclick="setTheme('blue')">Bleu</button>
    <button onclick="setTheme('green')">Vert</button>
    <button onclick="setTheme('purple')">Violet</button>
    <button onclick="setTheme('bordeaux')">Bordeaux</button>
  </div>

<script>
/* ===================== STATE ===================== */
let csvData = [];
let headers = [];
let chart = null;
let currentY = [];
let timeField = "";
let customColors = {};
let initialMin = null, initialMax = null;
let themeMenuTimer;

/* ===================== UTILS ===================== */
function getCSSVar(v){return getComputedStyle(document.documentElement).getPropertyValue(v).trim();}
function hexToRgb(hex){
  hex=hex.replace('#','');
  if(hex.length===3){hex=hex.split('').map(h=>h+h).join('');}
  const n=parseInt(hex,16);
  return {r:(n>>16)&255,g:(n>>8)&255,b:n&255};
}
function buildPalette(){
  return [
    getCSSVar('--accent'),
    getCSSVar('--danger'),
    "#3380ff","#4caf50","#ff33a6",
    "#8e44ad","#ffc300","#33cccc"
  ];
}
function getParam(n){return new URLSearchParams(window.location.search).get(n);}
function showSpinner(){document.getElementById('spinner').style.display='block';}
function hideSpinner(){document.getElementById('spinner').style.display='none';}
function showError(msg){
  hideSpinner();
  const box = document.getElementById('errorBox');
  if(msg) box.firstChild.textContent = msg;
  box.style.display='block';
}

/* ===================== THEME ===================== */
function applyThemeVars(vars){
  const r=document.documentElement;
  Object.entries(vars).forEach(([k,v])=>r.style.setProperty(k,v));
  const palette = buildPalette();
  if(chart){
    chart.data.datasets.forEach((ds,i)=>{
      const saved = customColors[ds.label];
      const c = saved || palette[i % palette.length];
      ds.borderColor = c;
      ds.backgroundColor = c;
    });
    chart.update('none');
  }
}
function setTheme(theme){
  localStorage.setItem("selectedTheme",theme);
  if(theme==="orange") applyThemeVars({"--accent":"#ff7043","--accent-darker":"#e64a19","--accent-muted":"#fff9f7","--bg":"#fff5f5","--panel":"#ffffff","--danger":"#d84315","--text":"#333"});
  if(theme==="blue")   applyThemeVars({"--accent":"#2196f3","--accent-darker":"#1976d2","--accent-muted":"#e3f1fc","--bg":"#e3f2fd","--panel":"#ffffff","--danger":"#0d47a1","--text":"#0d47a1"});
  if(theme==="green")  applyThemeVars({"--accent":"#4caf50","--accent-darker":"#2e7d32","--accent-muted":"#c8e6c9","--bg":"#f1f8e9","--panel":"#ffffff","--danger":"#1b5e20","--text":"#1b5e20"});
  if(theme==="purple") applyThemeVars({"--accent":"#9c27b0","--accent-darker":"#6a1b9a","--accent-muted":"#e1bee7","--bg":"#f3e5f5","--panel":"#ffffff","--danger":"#4a148c","--text":"#4a148c"});
  if(theme==="bordeaux")applyThemeVars({"--accent":"#800020","--accent-darker":"#4b0014","--accent-muted":"#d7a1a9","--bg":"#fff0f2","--panel":"#ffffff","--danger":"#600018","--text":"#4b0014"});
}
document.getElementById("secretBtn").onclick=()=>{
  const m=document.getElementById("themeMenu");
  if(m.style.display==="block"){closeThemeMenu();}else{m.style.display="block";resetThemeMenuTimer();}
};
function resetThemeMenuTimer(){clearTimeout(themeMenuTimer);themeMenuTimer=setTimeout(closeThemeMenu,10000);}
function closeThemeMenu(){document.getElementById("themeMenu").style.display="none";clearTimeout(themeMenuTimer);}

/* ===================== DATASETS ===================== */
function buildDatasets(){
  const palette = buildPalette();
  return currentY.map((col,i)=>{
    const saved = customColors[col];
    const baseColor = saved || palette[i % palette.length];
    const data = csvData
      .map(r => {
        const x = r.__dayKey;
        const y = r[col];
        return (Number.isFinite(x) && typeof y === "number") ? {x,y} : null;
      })
      .filter(Boolean);
    return {
      label: col,
      data,
      backgroundColor: baseColor,
      borderColor: baseColor,
      borderWidth: 1,
      barPercentage:0.7,
      categoryPercentage:0.9
    };
  });
}

/* ===================== PLUGIN FOND JOUR + TRAITS ===================== */
const dayBackgroundPlugin = {
  id:'dayBackground',
  beforeDraw(chart){
    const {scales:{x}, chartArea} = chart;
    if(!x || !isFinite(x.min) || !isFinite(x.max)) return;
    const oneDay = 86400000;
    let start = new Date(x.min);
    start.setHours(0,0,0,0);

    const ctx = chart.ctx;
    ctx.save();
    let toggle = false;

    for(let d = start.getTime(); d < x.max; d += oneDay){
      const from = x.getPixelForValue(d);
      const to   = x.getPixelForValue(d + oneDay);
      const w = to - from;
      if(!Number.isFinite(from) || !Number.isFinite(to) || w<=0) continue;

      // fond altern√© tr√®s clair
      ctx.fillStyle = toggle
        ? (getCSSVar('--accent-muted') || 'rgba(255,112,67,0.08)')
        : 'rgba(0,0,0,0.02)';
      ctx.fillRect(from, chartArea.top, w, chartArea.bottom - chartArea.top);

      // trait fin √† gauche du jour
      ctx.beginPath();
      ctx.moveTo(from, chartArea.top);
      ctx.lineTo(from, chartArea.bottom);
      ctx.lineWidth = 1;
      ctx.strokeStyle = "rgba(0,0,0,0.12)";
      ctx.stroke();

      toggle = !toggle;
    }
    ctx.restore();
  }
};

/* ===================== CHART ===================== */
function drawChart(){
  if(!csvData.length || !timeField || !currentY.length){
    if(chart){ chart.destroy(); chart=null; }
    return;
  }

  if(chart){ chart.destroy(); }

  const ctx = document.getElementById("myChart").getContext("2d");
  const datasets = buildDatasets();

  // bornes initiales X pour reset zoom
  const allX = csvData.map(r=>r.__dayKey).filter(v=>Number.isFinite(v));
  if(allX.length){
    const minX = Math.min(...allX);
    const maxX = Math.max(...allX);
    if(initialMin === null) initialMin = minX;
    if(initialMax === null) initialMax = maxX;
  }

  chart = new Chart(ctx,{
    type: "bar",
    data:{ datasets },
    options:{
      maintainAspectRatio:false,
      parsing:true,
      interaction:{mode:"index",intersect:false},
      plugins:{
        legend:{
          labels:{color:getCSSVar("--text")}
        },
        tooltip:{
          callbacks:{
            title:(items)=>{
              if(!items.length) return "";
              const ts = items[0].raw.x;
              return new Date(ts).toLocaleDateString("fr-FR");
            },
            label:(item)=> `${item.dataset.label} : ${item.raw.y}`
          }
        },
        zoom:{
          zoom:{
            wheel:{enabled:true,modifierKey:"ctrl"},
            drag:{enabled:true,mode:"x"}
          },
          pan:{enabled:true,mode:"x"}
        }
      },
      scales:{
x:{
  type:"time",
  time:{unit:"day",tooltipFormat:"dd/MM/yyyy",stepSize:1},
  offset:true,
  stacked:false,

          ticks:{
            autoSkip:false,
            callback:(value)=>{
              const d=new Date(value);
              return d.toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit"});
            }
          }
        },
        y:{
          beginAtZero:true,
          stacked:false,
          title:{display:true,text:"Valeurs"}
        }
      }
    },
    plugins:[dayBackgroundPlugin]
  });

  const picker=document.getElementById("colorPicker");

  // Ctrl+clic sur une barre pour changer la couleur du dataset
  chart.canvas.addEventListener("click",(ev)=>{
    if(!ev.ctrlKey) return;
    const elements = chart.getElementsAtEventForMode(ev,"nearest",{intersect:true},true);
    if(!elements.length) return;

    const dsIndex = elements[0].datasetIndex;
    const ds = chart.data.datasets[dsIndex];

    picker.oninput = e=>{
      const c=e.target.value;
      customColors[ds.label]=c;
      ds.backgroundColor=c;
      ds.borderColor=c;
      chart.update();
    };
    picker.click();
  });

  // apr√®s zoom / drag, on recalcule le rendu
  chart.canvas.addEventListener('mouseup', ()=>{ chart.update('none'); });
  chart.canvas.addEventListener('wheel', ()=>{ chart.update('none'); }, {passive:true});
}

/* ===================== UI ===================== */
document.getElementById("yColumnsContainer").addEventListener("change",()=>{
  currentY = Array.from(
    document.querySelectorAll("#yColumnsContainer input:checked")
  ).map(cb=>cb.value);
  drawChart();
});

document.getElementById("backBtn").onclick=()=>window.close();

document.getElementById("resetZoom").onclick=()=>{
  if(!chart || initialMin===null || initialMax===null) return;
  chart.resetZoom();
  chart.options.scales.x.min = initialMin;
  chart.options.scales.x.max = initialMax;
  chart.update('none');
};

/* ===================== EXPORT PDF ===================== */
document.getElementById('exportPDF').onclick = () => {
  if(!chart){
    alert("Aucun graphique √† exporter.");
    return;
  }

  let PDF = null;
  if(window.jspdf && window.jspdf.jsPDF) PDF = window.jspdf.jsPDF;
  else if(window.jsPDF) PDF = window.jsPDF;
  if(!PDF){
    alert("jsPDF non charg√©.");
    return;
  }

  const pdf = new PDF({orientation:"landscape"});
  const pageWidth = pdf.internal.pageSize.getWidth();
  const pageHeight = pdf.internal.pageSize.getHeight();

  const csvName = (getParam('fileName') || "export_gaz.csv").split("\\").pop();
  const titleTxt = "Consommation Gaz ‚Äî " + csvName;
  const danger = getCSSVar('--danger') || "#d84315";
  const {r,g,b} = hexToRgb(danger);

  pdf.setFontSize(16);
  pdf.setTextColor(r,g,b);
  const lines = pdf.splitTextToSize(titleTxt,pageWidth-20);
  pdf.text(lines,10,12);

  const baseCanvas = chart.canvas;
  const tmp = document.createElement("canvas");
  tmp.width = baseCanvas.width * 3;
  tmp.height = baseCanvas.height * 3;

  const ctx2 = tmp.getContext("2d");
  ctx2.fillStyle = "#ffffff";
  ctx2.fillRect(0,0,tmp.width,tmp.height);
  ctx2.scale(3,3);
  ctx2.imageSmoothingEnabled = false;
  ctx2.drawImage(baseCanvas,0,0);

  const img = tmp.toDataURL("image/jpeg",0.92);

  const maxW = pageWidth - 20;
  const maxH = pageHeight - 40;
  const scale = Math.min(maxW / baseCanvas.width, maxH / baseCanvas.height);
  const imgX = (pageWidth - baseCanvas.width*scale)/2;
  const imgY = 20;

  pdf.addImage(img,"JPEG",imgX,imgY,baseCanvas.width*scale,baseCanvas.height*scale);

  const allX = csvData.map(r=>r.__dayKey).filter(x=>Number.isFinite(x));
  if(allX.length){
    const minDate = new Date(Math.min(...allX)).toLocaleDateString("fr-FR");
    const maxDate = new Date(Math.max(...allX)).toLocaleDateString("fr-FR");
    pdf.setFontSize(10);
    pdf.setTextColor(80,80,80);
    pdf.text(`P√©riode : ${minDate} ‚Üí ${maxDate}`,pageWidth/2,imgY + baseCanvas.height*scale + 10,{align:"center"});
  }

  pdf.save(csvName.replace(/\.csv$/i,".pdf"));
};

/* ===================== INIT ===================== */
(async function init(){
  setTheme(localStorage.getItem("selectedTheme") || "orange");
  document.getElementById("resetZoom").style.display="inline-block";
  document.getElementById("exportPDF").style.display="inline-block";

  const params = new URLSearchParams(location.search);
  if(params.get("export_gaz")!=="1"){
    showError("Mode export gaz non activ√©.");
    return;
  }

  const raw = localStorage.getItem("exportGazCsvData");
  if(!raw){
    showError("‚ö†Ô∏è Aucun CSV gaz dans le stockage local.");
    return;
  }
  localStorage.removeItem("exportGazCsvData");

  showSpinner();
  const parsed = Papa.parse(raw,{
    header:true,
    dynamicTyping:true,
    skipEmptyLines:true
  });
  hideSpinner();

  csvData = parsed.data || [];
  headers = parsed.meta.fields || [];

  document.getElementById('fileName').textContent = "Export Gaz";
  document.getElementById('fileName').style.display = "block";
  document.getElementById('lineCount').textContent = csvData.length+" ligne"+(csvData.length>1?"s":"");
  document.getElementById('lineCount').style.display = "block";

  // d√©tection de la colonne date
  timeField = headers.find(h=>/date|jour|time/i.test((h||"").toLowerCase())) || headers[0];

  // convertir la date en timestamp minuit
  csvData.forEach(r=>{
    const d=new Date(r[timeField]);
    d.setHours(0,0,0,0);
    r.__dayKey=d.getTime();
  });

  // liste des colonnes Y √† gauche
  const yCont=document.getElementById("yColumnsContainer");
  yCont.innerHTML="";
  headers.forEach(h=>{
    if(h===timeField) return;
    const lab=document.createElement("label");
    lab.innerHTML=`<input type="checkbox" value="${h}" checked> ${h}`;
    yCont.appendChild(lab);
  });

  currentY = headers.filter(h=>h!==timeField);

  document.getElementById('columnSelectors').style.display="flex";

  drawChart();

  const zi = document.getElementById('zoomInfo');
  zi.style.display='block';
  setTimeout(()=>{zi.style.display='none';},5000);
})();
</script>

</body>
</html>
